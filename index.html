<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanProMax - å¤šç”¨æˆ·åä½œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app" v-cloak class="h-screen flex flex-col md:flex-row overflow-hidden text-slate-800">

    <!-- === ç™»å½•å±‚ï¼šæ²¡æœ‰ Key æ—¶æ˜¾ç¤º === -->
    <div v-if="!accessKey" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100/50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-white">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto shadow-lg mb-4 text-3xl">
                    <i class="ph-bold ph-check-square-offset"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-800">PlanPro Cloud</h1>
                <p class="text-sm text-slate-500 mt-2">è¾“å…¥æ‚¨çš„ä¸“å±å¯†é’¥ï¼Œæ•°æ®éšèº«å¸¦</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Access Key (è®¿é—®å‡­è¯)</label>
                    <input type="text" v-model="inputKey" @keyup.enter="login" placeholder="è¯·è¾“å…¥æˆ–åˆ›å»ºä¸€ä¸ªKey..." class="w-full mt-1 border-2 border-slate-100 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition font-mono text-center font-bold text-lg text-slate-700 bg-slate-50">
                </div>
                <button @click="login" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95 text-lg">
                    è¿›å…¥å·¥ä½œå°
                </button>
                <div class="text-center">
                    <button @click="generateKey" class="text-xs text-blue-500 hover:text-blue-700 font-bold flex items-center justify-center gap-1 mx-auto py-2">
                        <i class="ph-bold ph-magic-wand"></i> æ²¡æœ‰Keyï¼Ÿéšæœºç”Ÿæˆä¸€ä¸ª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- === ä¸»ç•Œé¢ï¼šæœ‰ Key æ—¶æ˜¾ç¤º === -->
    <template v-if="accessKey">
        <!-- å·¦ä¾§å¯¼èˆª -->
        <aside class="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg shrink-0">
            <div class="p-6 flex items-center gap-3 border-b border-slate-100 h-16">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                    <i class="ph ph-check-square-offset text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h1 class="text-lg font-bold tracking-tight text-slate-800 leading-tight">PlanPro_ZY</h1>
                    <div class="text-[10px] text-slate-400 font-mono truncate" title="å½“å‰Key">ğŸ”‘ {{ accessKey }}</div>
                </div>
            </div>

            <!-- åŒæ­¥çŠ¶æ€æ  -->
            <div class="px-6 py-2">
                <div class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border transition-colors" :class="syncStatus.class">
                    <i :class="syncStatus.icon"></i><span class="font-bold">{{ syncStatus.text }}</span>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <button @click="switchView('dashboard')" class="nav-btn" :class="currentView === 'dashboard' ? 'active-blue' : 'inactive'">
                    <i class="ph ph-sun text-lg"></i> ä»Šæ—¥çœ‹æ¿
                    <span v-if="activeTasks.length > 0" class="ml-auto bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">{{ activeTasks.length }}</span>
                </button>
                <button @click="switchView('templates')" class="nav-btn" :class="currentView === 'templates' ? 'active-purple' : 'inactive'"><i class="ph ph-copy text-lg"></i> ä»»åŠ¡æ¨¡æ¿</button>
                <button @click="switchView('scheduled')" class="nav-btn" :class="currentView === 'scheduled' ? 'active-teal' : 'inactive'">
                    <i class="ph ph-clock-countdown text-lg"></i> å®šæ—¶ä»»åŠ¡
                    <span v-if="enabledScheduledCount > 0" class="ml-auto bg-teal-100 text-teal-700 text-[10px] px-2 py-0.5 rounded-full">{{ enabledScheduledCount }}</span>
                </button>
                <button @click="switchView('statistics')" class="nav-btn" :class="currentView === 'statistics' ? 'active-indigo' : 'inactive'"><i class="ph ph-chart-bar text-lg"></i> æ•°æ®ç»Ÿè®¡</button>
            </nav>

            <div class="p-4 border-t border-slate-100 bg-slate-50">
                <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">æ•°æ®ç®¡ç†</div>
                <div class="grid grid-cols-4 gap-2">
                    <button @click="exportData" class="action-btn hover:text-blue-600"><i class="ph ph-download-simple"></i> å¤‡ä»½</button>
                    <button @click="$refs.fileInput.click()" class="action-btn hover:text-blue-600"><i class="ph ph-upload-simple"></i> æ¢å¤</button>
                    
                    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
                    <button @click="logout" class="action-btn col-span-2 text-red-500 hover:bg-red-50 hover:text-red-700 font-bold border-red-100 group">
                        <i class="ph-bold ph-sign-out group-hover:hidden"></i><i class="ph-bold ph-x group-hover:inline hidden"></i> åˆ‡æ¢è´¦å·
                    </button>
                    
                    <button @click="handleClearData" class="action-btn col-span-2 hover:text-red-600 hover:bg-red-50"><i class="ph ph-trash"></i> åˆ åº“</button>
                    <input type="file" ref="fileInput" @change="importData" class="hidden" accept=".json">
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº (ä¿æŒåŸæ ·) -->
        <main class="flex-1 flex flex-col relative bg-[#f1f5f9] min-w-0 border-r border-slate-200">
            <template v-if="currentView === 'dashboard'">
                <header class="header-bar">
                    <div class="flex items-center gap-3">
                        <button @click="changeDate(-1)" class="icon-btn"><i class="ph-bold ph-caret-left"></i></button>
                        <div class="flex flex-col items-center">
                            <div class="relative group">
                                <input type="date" v-model="viewDate" class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full">
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-1 cursor-pointer group-hover:text-blue-600">{{ dateInfo.date }} <i class="ph-fill ph-caret-down text-xs text-slate-400"></i></h2>
                            </div>
                            <div class="text-xs text-slate-500 font-medium">{{ dateInfo.week }}</div>
                        </div>
                        <button @click="changeDate(1)" class="icon-btn"><i class="ph-bold ph-caret-right"></i></button>
                        <button v-if="viewDate !== today" @click="resetToToday" class="ml-2 text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-md font-bold hover:bg-blue-100 transition">å›åˆ°ä»Šå¤©</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <div v-if="overdueCount > 0 && viewDate === today" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 flex items-center gap-1 mr-2">
                            <i class="ph-fill ph-warning"></i> {{ overdueCount }} è¶…æ—¶
                        </div>
                        <button @click="toggleAll" class="h-9 px-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-sm">
                            <i :class="isAllExpanded ? 'ph ph-arrows-in-line-vertical' : 'ph ph-arrows-out-line-vertical'"></i><span class="hidden sm:inline">{{ isAllExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}</span>
                        </button>
                        <button @click="openModal()" class="primary-btn"><i class="ph ph-plus-bold"></i> <span class="hidden sm:inline">æ–°å»º</span></button>
                    </div>
                </header>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
                    <div v-if="futurePreviews.length > 0" class="mb-6">
                        <h3 class="section-title text-teal-600"><i class="ph-fill ph-calendar-plus"></i> å¾…è‡ªåŠ¨ç”Ÿæˆ ({{ futurePreviews.length }}) <div class="h-px bg-teal-100 flex-1"></div></h3>
                        <div v-for="task in futurePreviews" :key="task.id" @click="selectTask(task)" class="task-card future-card bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-3 flex items-center gap-3 cursor-pointer group hover:bg-white transition-colors" :class="{'active': activeTask && activeTask.id === task.id}">
                            <div class="w-6 flex justify-center text-slate-300"><i class="ph-bold ph-clock-countdown text-lg"></i></div>
                            <div class="relative w-24 shrink-0 pointer-events-none opacity-70"><div class="w-full py-1.5 rounded-lg text-xs font-bold border text-center bg-white" :class="getPriorityStyle(task.priority)">{{ {normal:'æ™®é€š', urgent:'ç´§æ€¥', critical:'ç‰¹æ€¥'}[task.priority] }}</div></div>
                            <div class="font-bold text-slate-600 text-sm">{{ task.title }}</div><div class="flex-1 text-[10px] text-slate-400 italic ml-2">å°†åœ¨ {{ viewDate }} è‡ªåŠ¨åˆ›å»º</div>
                        </div>
                    </div>
                    <div v-if="activeTasks.length === 0 && completedTasks.length === 0 && futurePreviews.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-coffee text-4xl mb-2"></i><p class="text-sm">{{ viewDate === today ? 'ä»Šæ—¥æ— ä»»åŠ¡' : 'å½“å¤©æ— å®‰æ’' }}</p></div>
                    <div v-for="task in activeTasks" :key="task.id" @click="selectTask(task)" class="task-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === task.id}">
                        <div v-if="isOverdue(task)" class="absolute top-0 left-0 right-0 h-1 bg-red-500 z-10"></div>
                        <div v-else-if="isDueToday(task)" class="absolute top-0 left-0 right-0 h-1 bg-orange-400 z-10"></div>
                        <div class="p-3 flex items-center gap-3 relative z-0 h-16">
                            <button @click.stop="task.expanded = !task.expanded" class="shrink-0 text-slate-400 hover:text-blue-600 transition-transform duration-200 w-6" :class="{'rotate-90': task.expanded}"><i class="ph-bold ph-caret-right text-lg"></i></button>
                            <div class="relative w-24 shrink-0" @click.stop><select v-model="task.priority" class="w-full appearance-none pl-7 pr-2 py-1.5 rounded-lg text-xs font-bold border focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors cursor-pointer bg-white" :class="getPriorityStyle(task.priority)"><option value="normal">æ™®é€š</option><option value="urgent">ç´§æ€¥</option><option value="critical">ç‰¹æ€¥</option></select><div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"><i v-if="task.priority==='normal'" class="ph-fill ph-flag text-blue-500"></i><i v-if="task.priority==='urgent'" class="ph-fill ph-flag text-orange-500"></i><i v-if="task.priority==='critical'" class="ph-fill ph-flag text-red-500"></i></div></div>
                            <div class="relative w-28 shrink-0" @click.stop><select v-model="task.status" @change="updateStatus(task)" class="w-full appearance-none pl-7 pr-2 py-1.5 rounded-lg text-xs font-bold border focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors cursor-pointer bg-white" :class="getStatusStyle(task.status)"><option value="todo">æœªå¼€å§‹</option><option value="doing">è¿›è¡Œä¸­</option><option value="done">å·²å®Œæˆ</option></select><div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"><i v-if="task.status==='todo'" class="ph ph-circle text-slate-400"></i><i v-if="task.status==='doing'" class="ph ph-spinner animate-spin text-blue-600"></i><i v-if="task.status==='done'" class="ph ph-check-circle text-green-600"></i></div></div>
                            <div class="font-bold text-slate-800 text-sm whitespace-nowrap shrink-0 flex items-center gap-2">{{ task.title }}<span class="text-[10px] font-normal text-slate-400 font-mono bg-slate-100 px-1 rounded">{{ formatTimeOnly(task.date) }}</span><span v-if="isOverdue(task)" class="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold border border-red-200">è¶…æ—¶</span></div>
                            <div class="flex-1 min-w-0 border-l border-slate-200 pl-3 ml-1"><div v-if="task.note" class="text-xs text-slate-400 truncate font-mono">{{ getLatestNoteLine(task.note) }}</div><div v-else class="text-[10px] text-slate-300 italic truncate">æ— æè¿°</div></div>
                            <div class="flex items-center gap-1 ml-2"><button @click.stop="openModal(task)" class="icon-btn-sm hover:bg-blue-50 hover:text-blue-600"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(task.id)" class="icon-btn-sm hover:bg-red-50 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div>
                        </div>
                        <transition name="slide"><div v-if="task.expanded" class="bg-slate-50 border-t border-slate-100 px-4 py-3 ml-[3.5rem]" @click.stop><div class="space-y-2"><div v-for="(sub, idx) in task.subtasks" :key="idx" class="flex items-start gap-2"><label class="flex items-center gap-2 cursor-pointer select-none flex-1"><input type="checkbox" :checked="sub.status === 'done'" @change="toggleSubtask(task, sub)" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"><span class="text-sm text-slate-700 transition-all" :class="{'line-through text-slate-400': sub.status === 'done'}">{{ sub.title }}</span></label><button @click="task.subtasks.splice(idx,1)" class="text-slate-300 hover:text-red-500"><i class="ph ph-x"></i></button></div><div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200 border-dashed"><i class="ph ph-plus text-slate-400 text-xs"></i><input type="text" placeholder="æ·»åŠ å­æ­¥éª¤..." @keydown.enter="addInlineSubtask(task, $event)" class="bg-transparent text-xs w-full focus:outline-none text-slate-600 placeholder-slate-400"></div></div></div></transition>
                    </div>
                    <div v-if="completedTasks.length > 0" class="pt-8 pb-4">
                        <h3 class="section-title text-slate-400"><i class="ph-bold ph-archive"></i> å·²å®Œæˆ <div class="h-px bg-slate-200 flex-1"></div></h3>
                        <div class="space-y-2"><div v-for="task in completedTasks" :key="task.id" @click="selectTask(task)" class="task-card bg-slate-50 border border-slate-200 rounded-lg p-3 flex items-center gap-3 cursor-pointer hover:bg-white transition-all" :class="{'active': activeTask && activeTask.id === task.id, 'opacity-60 grayscale': (!activeTask || activeTask.id !== task.id)}"><button @click.stop="task.status = 'doing'; updateStatus(task)" class="text-green-600 hover:text-green-700"><i class="ph-fill ph-check-circle text-xl"></i></button><div class="flex-1"><div class="text-sm line-through text-slate-500 font-medium">{{ task.title }}</div><div class="text-[10px] text-slate-400">å½’æ¡£äº: {{ formatDateTime(task.completedDate) }}</div></div></div></div>
                    </div>
                </div>
            </template>

            <!-- æ¨¡æ¿ã€å®šæ—¶ã€ç»Ÿè®¡è§†å›¾ (ä¿æŒåŸæ ·ï¼Œåªæ›´æ–°å¤´éƒ¨æ ·å¼ä»¥åŒ¹é…) -->
            <template v-if="currentView === 'templates'">
                 <header class="header-bar">
                    <div><h2 class="text-lg font-bold text-purple-800">ä»»åŠ¡æ¨¡æ¿åº“</h2><div class="text-xs text-slate-500">é¢„è®¾å¸¸ç”¨ä»»åŠ¡</div></div>
                    <button @click="openModal()" class="primary-btn bg-purple-600 shadow-purple-200 hover:bg-purple-700"><i class="ph ph-plus-bold"></i> æ–°å»ºæ¨¡æ¿</button>
                </header>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
                    <div v-if="templates.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-copy text-4xl mb-2 text-purple-200"></i><p class="text-sm">æš‚æ— æ¨¡æ¿</p></div>
                    <div v-for="tmpl in templates" :key="tmpl.id" @click="selectTask(tmpl)" class="task-card template-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === tmpl.id}">
                        <div class="p-3 flex items-center gap-3 relative z-0 h-16"><div class="font-bold text-slate-800 text-sm flex-1">{{ tmpl.title }}</div><div class="flex items-center gap-1 ml-2"><button @click.stop="openModal(tmpl)" class="icon-btn-sm hover:bg-purple-50 hover:text-purple-600"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(tmpl.id)" class="icon-btn-sm hover:bg-red-50 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div></div>
                    </div>
                </div>
            </template>

            <template v-if="currentView === 'scheduled'">
                <header class="header-bar">
                    <div><h2 class="text-lg font-bold text-teal-800">å®šæ—¶ä»»åŠ¡ç®¡ç†</h2><div class="text-xs text-slate-500">æ¯å‘¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨åŠ å…¥çœ‹æ¿</div></div>
                    <button @click="openModal()" class="primary-btn bg-teal-600 shadow-teal-200 hover:bg-teal-700"><i class="ph ph-plus-bold"></i> æ–°å»ºå®šæ—¶</button>
                </header>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
                    <div v-if="scheduledTasks.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-clock-countdown text-4xl mb-2 text-teal-200"></i><p class="text-sm">æš‚æ— å®šæ—¶ä»»åŠ¡</p></div>
                    <div v-for="sch in scheduledTasks" :key="sch.id" @click="selectTask(sch)" class="task-card scheduled-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === sch.id, 'disabled': !sch.enabled}">
                        <div class="p-3 flex items-center gap-3 relative z-0 h-16"><label class="relative inline-flex items-center cursor-pointer shrink-0" @click.stop><input type="checkbox" v-model="sch.enabled" class="sr-only peer"><div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-teal-600"></div></label><div class="font-bold text-slate-800 text-sm whitespace-nowrap shrink-0" :class="{'text-slate-400': !sch.enabled}">{{ sch.title }}</div><div class="flex gap-1 flex-1"><span v-for="d in formatRepeatDays(sch.repeatDays)" class="bg-teal-50 text-teal-600 text-[10px] px-1.5 py-0.5 rounded font-bold border border-teal-100" :class="{'opacity-50': !sch.enabled}">{{ d }}</span></div><div class="flex items-center gap-1 ml-2"><button @click.stop="openModal(sch)" class="icon-btn-sm hover:bg-teal-50 hover:text-teal-600"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(sch.id)" class="icon-btn-sm hover:bg-red-50 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div></div>
                    </div>
                </div>
            </template>

            <template v-if="currentView === 'statistics'">
                 <header class="header-bar">
                    <div><h2 class="text-lg font-bold text-indigo-800">æ•°æ®ç»Ÿè®¡</h2></div>
                     <div class="flex items-center gap-2">
                        <button @click="setStatsRange('week')" class="px-3 py-1 text-xs bg-white border border-slate-200 rounded hover:bg-slate-50">æœ¬å‘¨</button>
                        <button @click="setStatsRange('month')" class="px-3 py-1 text-xs bg-white border border-slate-200 rounded hover:bg-slate-50">æœ¬æœˆ</button>
                     </div>
                </header>
                <div class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth pb-20">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="stat-card border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase mb-1">æ€»ä»»åŠ¡æ•°</div><div class="text-3xl font-black text-slate-700">{{ statsData.total }}</div></div>
                        <div class="stat-card border-slate-100"><div class="text-xs font-bold text-green-500 uppercase mb-1">å·²å®Œæˆ</div><div class="text-3xl font-black text-green-600">{{ statsData.done }}</div></div>
                         <div class="stat-card border-slate-100"><div class="text-xs font-bold text-blue-500 uppercase mb-1">è¿›è¡Œä¸­</div><div class="text-3xl font-black text-blue-600">{{ statsData.doing }}</div></div>
                         <div class="stat-card border-slate-100"><div class="text-xs font-bold text-gray-500 uppercase mb-1">æœªå¼€å§‹</div><div class="text-3xl font-black text-gray-600">{{ statsData.todo }}</div></div>
                    </div>
                </div>
            </template>
        </main>

        <!-- å³ä¾§è¯¦æƒ… (å…±ç”¨) -->
        <aside class="hidden md:flex w-[350px] bg-white border-l border-slate-200 flex-col z-10 shrink-0 h-full shadow-[-4px_0_15px_rgba(0,0,0,0.02)]">
            <div class="h-16 border-b border-slate-100 flex items-center px-6 bg-slate-50/80">
                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph ph-sliders-horizontal"></i> ä»»åŠ¡è¯¦æƒ…</h3>
            </div>
            <div v-if="activeTask" class="flex-1 overflow-y-auto p-6 flex flex-col h-full">
                <div class="mb-6">
                     <h2 class="text-2xl font-black text-slate-800 leading-snug">{{ activeTask.title }}</h2>
                </div>
                <div class="flex-1 flex flex-col mb-6 min-h-[150px]">
                    <textarea v-model="activeTask.note" placeholder="è¾“å…¥å†…å®¹..." class="flex-1 w-full bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-sm text-slate-700 leading-relaxed focus:outline-none focus:ring-2 focus:ring-yellow-300 resize-none font-mono"></textarea>
                </div>
            </div>
            <div v-else class="h-full flex flex-col items-center justify-center text-center opacity-40 p-10"><i class="ph ph-hand-tap text-5xl text-slate-300 mb-4 animate-bounce"></i><h4 class="font-bold text-slate-600 text-lg">ç‚¹å‡»åˆ—è¡¨é¡¹</h4></div>
        </aside>

        <!-- æ¨¡æ€æ¡† (ä¿æŒåŸæ ·) -->
        <div v-if="modal.show" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="modal.show = false" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative flex flex-col max-h-[90vh] overflow-hidden transform transition-all">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-lg text-slate-800">{{ modal.isEdit ? 'ç¼–è¾‘' : 'æ–°å»º' }}{{ getViewName() }}</h3>
                    <button @click="modal.show = false" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="p-6 overflow-y-auto space-y-5">
                    <div v-if="currentView === 'dashboard' && !modal.isEdit && templates.length > 0" class="bg-purple-50 border border-purple-100 rounded-lg p-3">
                        <label class="text-xs font-bold text-purple-600 uppercase mb-1 block flex items-center gap-1"><i class="ph-bold ph-magic-wand"></i> å¿«é€ŸåŠ è½½æ¨¡æ¿</label>
                        <select @change="loadTemplate($event)" class="w-full bg-white border border-purple-200 rounded px-2 py-1.5 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-200"><option value="">-- é€‰æ‹©æ¨¡æ¿ --</option><option v-for="t in templates" :key="t.id" :value="t.id">{{ t.title }}</option></select>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">åç§°</label><input v-model="modal.data.title" type="text" class="w-full text-lg font-bold border-b-2 border-slate-200 py-1 focus:border-blue-500 outline-none bg-transparent" placeholder="è¾“å…¥åç§°"></div>
                    <div v-if="currentView === 'scheduled'" class="bg-teal-50 p-4 rounded-xl border border-teal-100"><label class="text-xs font-bold text-teal-700 uppercase mb-2 block">é‡å¤å‘¨æœŸ (è‡ªåŠ¨æ·»åŠ åˆ°å½“å¤©)</label><div class="flex justify-between gap-1"><label v-for="(dayStr, idx) in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="idx" class="cursor-pointer"><input type="checkbox" :value="idx === 6 ? 0 : idx + 1" v-model="modal.data.repeatDays" class="hidden peer"><span class="block w-8 h-8 rounded-full border border-teal-200 bg-white text-center leading-8 text-sm text-slate-500 peer-checked:bg-teal-500 peer-checked:text-white peer-checked:border-teal-500 transition-all select-none hover:border-teal-400">{{ dayStr }}</span></label></div></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">å¤‡æ³¨</label><textarea v-model="modal.data.note" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm resize-none"></textarea></div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><label class="text-xs font-bold text-slate-500 uppercase mb-2 block">å­ä»»åŠ¡åˆ—è¡¨ (å¯æ‹–æ‹½æ’åº)</label><div class="space-y-2"><div v-for="(sub, index) in modal.data.subtasks" :key="sub._key || index" class="flex gap-2 items-center group" draggable="true" @dragstart="dragStart(index, $event)" @dragover.prevent @dragenter.prevent @drop="dragDrop(index)" @dragend="dragEnd"><i class="ph-bold ph-dots-six-vertical text-slate-300 cursor-move hover:text-slate-500"></i><input v-model="sub.title" class="flex-1 bg-white border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-400"><button @click="modal.data.subtasks.splice(index, 1)" class="text-slate-400 hover:text-red-500"><i class="ph-bold ph-trash"></i></button></div><div class="flex gap-2"><input type="text" ref="newSubInput" placeholder="è¾“å…¥æ–°å­ä»»åŠ¡æŒ‰å›è½¦..." @keydown.enter="addModalSubtask" class="flex-1 bg-transparent border-b border-slate-300 focus:border-blue-500 px-2 py-1 text-sm outline-none"><button @click="addModalSubtask" class="text-blue-600 text-sm font-bold">æ·»åŠ </button></div></div></div>
                    <div v-if="currentView === 'dashboard'" class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-slate-500 uppercase">è®¡åˆ’æ—¶é—´</label><input type="datetime-local" v-model="modal.data.date" class="w-full border border-slate-200 rounded px-2 py-2 text-sm"></div><div><label class="text-xs font-bold text-slate-500 uppercase">æˆªæ­¢æ—¶é—´</label><input type="datetime-local" v-model="modal.data.deadline" class="w-full border border-slate-200 rounded px-2 py-2 text-sm"></div></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">ä¼˜å…ˆçº§</label><div class="flex gap-2"><button v-for="p in ['normal','urgent','critical']" :key="p" @click="modal.data.priority = p" class="flex-1 py-1.5 rounded text-xs border transition-all" :class="modal.data.priority === p ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200'">{{ {normal:'æ™®é€š', urgent:'ç´§æ€¥', critical:'ç‰¹æ€¥'}[p] }}</button></div></div>
                </div>
                <div class="p-4 border-t border-slate-100 flex justify-end gap-3 bg-white">
                    <button @click="modal.show = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="saveTask" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </template>

</div>

<script src="script.js"></script>
</body>
</html>
