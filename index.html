<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlanProMax Cloud - å…¨åŠŸèƒ½åŒæ­¥ç‰ˆ</title>
    <!-- æ ¸å¿ƒåº“å¼•å…¥ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="app" v-cloak class="h-screen flex flex-col md:flex-row overflow-hidden text-slate-800">

        <!-- === 1. ç™»å½•å±‚ (æ²¡æœ‰ Key æ—¶æ˜¾ç¤º) === -->
        <div v-if="!accessKey" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100/50 backdrop-blur-sm p-4 mobile-modal-container">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-white mobile-bottom-sheet">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto shadow-lg mb-4 text-3xl">
                        <i class="ph-bold ph-check-square-offset"></i>
                    </div>
                    <h1 class="text-2xl font-black text-slate-800">PlanPro Cloud</h1>
                    <p class="text-sm text-slate-500 mt-2">è¾“å…¥ Key è®¿é—®æ‚¨çš„äº‘ç«¯æ•°æ®</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Access Key</label>
                        <input type="text" v-model="inputKey" @keyup.enter="login" placeholder="è¯·è¾“å…¥æˆ–åˆ›å»º Key..." class="w-full mt-1 border-2 border-slate-100 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition font-mono text-center font-bold text-lg text-slate-700 bg-slate-50">
                    </div>
                    <button @click="login" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95 text-lg">è¿›å…¥å·¥ä½œå°</button>
                    <div class="text-center">
                        <button @click="generateKey" class="text-xs text-blue-500 hover:text-blue-700 font-bold flex items-center justify-center gap-1 mx-auto py-2"><i class="ph-bold ph-magic-wand"></i> éšæœºç”Ÿæˆ Key</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === 2. ä¸»ç•Œé¢ (æœ‰ Key æ—¶æ˜¾ç¤º) === -->
        <template v-if="accessKey">

            <!-- å·¦ä¾§å¯¼èˆª (æ¡Œé¢ç«¯æ˜¾ç¤ºï¼Œç§»åŠ¨ç«¯éšè—) -->
            <aside class="hidden md:flex w-64 bg-white border-r border-slate-200 flex-col z-20 shadow-lg shrink-0">
                <div class="p-6 flex items-center gap-3 border-b border-slate-100 h-16">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md"><i class="ph ph-check-square-offset text-xl"></i></div>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-lg font-bold tracking-tight text-slate-800 leading-tight">PlanPro</h1>
                        <div class="text-[10px] text-slate-400 font-mono truncate" title="å½“å‰Key">ğŸ”‘ {{ accessKey }}</div>
                    </div>
                </div>

                <!-- åŒæ­¥çŠ¶æ€ -->
                <div class="px-6 py-2">
                    <div class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border transition-colors" :class="syncStatus.class">
                        <i :class="syncStatus.icon"></i><span class="font-bold">{{ syncStatus.text }}</span>
                    </div>
                </div>

                <nav class="flex-1 p-4 space-y-2">
                    <button @click="switchView('dashboard')" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold" :class="currentView === 'dashboard' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'">
                        <i class="ph ph-sun text-lg"></i> ä»Šæ—¥çœ‹æ¿ <span v-if="activeTasks.length > 0" class="ml-auto bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">{{ activeTasks.length }}</span>
                    </button>
                    <button @click="switchView('templates')" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold" :class="currentView === 'templates' ? 'bg-purple-50 text-purple-700' : 'text-slate-600 hover:bg-slate-50'">
                        <i class="ph ph-copy text-lg"></i> ä»»åŠ¡æ¨¡æ¿
                    </button>
                    <button @click="switchView('scheduled')" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold" :class="currentView === 'scheduled' ? 'bg-teal-50 text-teal-700' : 'text-slate-600 hover:bg-slate-50'">
                        <i class="ph ph-clock-countdown text-lg"></i> å®šæ—¶ä»»åŠ¡ <span v-if="enabledScheduledCount > 0" class="ml-auto bg-teal-100 text-teal-700 text-[10px] px-2 py-0.5 rounded-full">{{ enabledScheduledCount }}</span>
                    </button>
                    <button @click="switchView('statistics')" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold" :class="currentView === 'statistics' ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-slate-50'">
                        <i class="ph ph-chart-bar text-lg"></i> æ•°æ®ç»Ÿè®¡
                    </button>
                </nav>

                <div class="p-4 border-t border-slate-100 bg-slate-50">
                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">ç³»ç»Ÿç®¡ç†</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="exportData" class="flex items-center justify-center gap-1 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 hover:text-blue-600"><i class="ph ph-download-simple"></i> å¤‡ä»½</button>
                        <button @click="$refs.fileInput.click()" class="flex items-center justify-center gap-1 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 hover:text-blue-600"><i class="ph ph-upload-simple"></i> æ¢å¤</button>
                        <button @click="logout" class="col-span-2 flex items-center justify-center gap-1 py-2 bg-white border border-red-100 rounded-lg text-xs text-red-500 hover:bg-red-50 font-bold"><i class="ph-bold ph-sign-out"></i> åˆ‡æ¢è´¦å·</button>
                        <button @click="handleClearData" class="col-span-2 flex items-center justify-center gap-1 py-2 text-[10px] text-slate-400 hover:text-red-600 mt-1"><i class="ph ph-trash"></i> åˆ åº“è·‘è·¯</button>
                        <input type="file" ref="fileInput" @change="importData" class="hidden" accept=".json">
                    </div>
                </div>
            </aside>

            <!-- ä¸­é—´å†…å®¹åŒº -->
            <main class="flex-1 flex flex-col relative bg-[#f1f5f9] min-w-0 border-r border-slate-200 mobile-pb">

                <!-- View A: ä»Šæ—¥çœ‹æ¿ -->
                <template v-if="currentView === 'dashboard'">
                    <!-- ğŸŸ¢ ä¿®å¤1: ä¼˜åŒ–å¤´éƒ¨ï¼Œé˜²æ­¢æŒ‰é’®æŒ¤å‹ -->
                    <header class="h-16 bg-white/90 backdrop-blur px-2 md:px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                        <!-- å·¦ä¾§ï¼šæ—¥æœŸå¯¼èˆª -->
                        <div class="flex items-center gap-1 md:gap-3 flex-1 min-w-0 overflow-hidden">
                            <button @click="changeDate(-1)" class="w-8 h-8 flex shrink-0 items-center justify-center rounded-lg hover:bg-slate-200 text-slate-600"><i class="ph-bold ph-caret-left"></i></button>
                            <div class="flex flex-col items-center min-w-[5rem]">
                                <div class="relative group w-full text-center">
                                    <input type="date" v-model="viewDate" class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full">
                                    <h2 class="text-xs md:text-lg font-bold text-slate-800 flex items-center justify-center gap-1 cursor-pointer whitespace-nowrap">{{ dateInfo.date }} <i class="ph-fill ph-caret-down text-xs text-slate-400"></i></h2>
                                </div>
                                <div class="text-[10px] md:text-xs text-slate-500 font-medium whitespace-nowrap">{{ dateInfo.week }}</div>
                            </div>
                            <button @click="changeDate(1)" class="w-8 h-8 flex shrink-0 items-center justify-center rounded-lg hover:bg-slate-200 text-slate-600"><i class="ph-bold ph-caret-right"></i></button>
                            <button v-if="viewDate !== today" @click="resetToToday" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-md font-bold whitespace-nowrap shrink-0">ä»Š</button>
                        </div>

                        <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® (å¼ºåˆ¶æ˜¾ç¤ºï¼Œç¼©å°é—´è·) -->
                        <div class="flex items-center gap-1 ml-1 shrink-0">
                            <button @click="toggleAll" class="h-8 w-8 md:h-9 md:w-auto md:px-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shrink-0">
                                <i :class="isAllExpanded ? 'ph ph-arrows-in-line-vertical' : 'ph ph-arrows-out-line-vertical'"></i>
                                <span class="hidden md:inline">{{ isAllExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}</span>
                            </button>
                            <button @click="openModal()" class="h-8 w-8 md:h-9 md:px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md shadow-blue-200 flex items-center justify-center gap-2 shrink-0">
                                <i class="ph ph-plus-bold"></i>
                                <span class="hidden md:inline">æ–°å»º</span>
                            </button>
                        </div>
                    </header>

                    <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth">
                        <!-- é¢„è§ˆåŒº -->
                        <div v-if="futurePreviews.length > 0" class="mb-6">
                            <h3 class="text-xs font-bold text-teal-600 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ph-fill ph-calendar-plus"></i> å¾…è‡ªåŠ¨ç”Ÿæˆ <div class="h-px bg-teal-100 flex-1"></div></h3>
                            <div v-for="task in futurePreviews" :key="task.id" @click="selectTask(task)" class="task-card future-card bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-3 flex items-center gap-3 cursor-pointer">
                                <div class="w-6 flex justify-center text-slate-300"><i class="ph-bold ph-clock-countdown text-lg"></i></div>
                                <div class="font-bold text-slate-600 text-sm">{{ task.title }}</div>
                            </div>
                        </div>

                        <!-- ç©ºçŠ¶æ€ -->
                        <div v-if="activeTasks.length === 0 && completedTasks.length === 0 && futurePreviews.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-coffee text-4xl mb-2"></i><p class="text-sm">ä»Šæ—¥æ— ä»»åŠ¡</p></div>

                        <!-- è¿›è¡Œä¸­ä»»åŠ¡åˆ—è¡¨ -->
                        <div v-for="task in activeTasks" :key="task.id" @click="selectTask(task)" class="task-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === task.id}">
                            <div v-if="isOverdue(task)" class="absolute top-0 left-0 right-0 h-1 bg-red-500 z-10"></div>
                            <div class="p-3 flex items-center gap-2 md:gap-3 relative z-0 min-h-[4rem]">
                                <!-- å±•å¼€ç®­å¤´ -->
                                <button @click.stop="task.expanded = !task.expanded" class="shrink-0 text-slate-400 w-5 md:w-6" :class="{'rotate-90': task.expanded}"><i class="ph-bold ph-caret-right text-lg"></i></button>

                                <!-- ä¼˜å…ˆçº§ -->
                                <div class="relative w-14 md:w-24 shrink-0" @click.stop>
                                    <select v-model="task.priority" class="w-full appearance-none px-1 md:pl-7 md:pr-2 py-1.5 rounded-lg text-xs font-bold border bg-white focus:outline-none text-center md:text-left" :class="getPriorityStyle(task.priority)">
                                        <option value="normal">æ™®é€š</option>
                                        <option value="urgent">ç´§æ€¥</option>
                                        <option value="critical">ç‰¹æ€¥</option>
                                    </select>
                                    <div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none hidden md:block">
                                        <i class="ph-fill ph-flag" :class="{'text-blue-500':task.priority==='normal', 'text-orange-500':task.priority==='urgent', 'text-red-500':task.priority==='critical'}"></i>
                                    </div>
                                </div>

                                <!-- çŠ¶æ€ -->
                                <div class="relative w-16 md:w-28 shrink-0" @click.stop>
                                    <select v-model="task.status" @change="updateStatus(task)" class="w-full appearance-none px-1 md:pl-7 md:pr-2 py-1.5 rounded-lg text-xs font-bold border bg-white focus:outline-none text-center md:text-left" :class="getStatusStyle(task.status)">
                                        <option value="todo">æœªå¼€å§‹</option>
                                        <option value="doing">è¿›è¡Œä¸­</option>
                                        <option value="done">å·²å®Œæˆ</option>
                                    </select>
                                    <div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none hidden md:block">
                                        <i v-if="task.status==='todo'" class="ph ph-circle text-slate-400"></i>
                                        <i v-if="task.status==='doing'" class="ph ph-spinner animate-spin text-blue-600"></i>
                                        <i v-if="task.status==='done'" class="ph ph-check-circle text-green-600"></i>
                                    </div>
                                </div>

                                <!-- æ ‡é¢˜ (æˆªæ–­) -->
                                <div class="flex-1 w-0 min-w-0 font-bold text-slate-800 text-sm flex items-center gap-2">
                                    <span class="truncate block">{{ task.title }}</span>
                                    <span class="text-[10px] font-normal text-slate-400 font-mono bg-slate-100 px-1 rounded hidden md:inline shrink-0">{{ formatTimeOnly(task.date) }}</span>
                                </div>

                                <!-- å¤‡æ³¨ (ç”µè„‘ç«¯) -->
                                <div class="flex-1 min-w-0 border-l border-slate-200 pl-3 ml-1 hidden md:block"><div v-if="task.note" class="text-xs text-slate-400 truncate font-mono">{{ getLatestNoteLine(task.note) }}</div></div>

                                <!-- æ“ä½œæŒ‰é’® -->
                                <div class="flex items-center gap-1 shrink-0 ml-1">
                                    <button @click.stop="openModal(task)" class="p-1.5 text-slate-300 hover:text-blue-600 hover:bg-blue-50 rounded"><i class="ph ph-pencil-simple text-lg"></i></button>
                                    <button @click.stop="deleteTask(task.id)" class="p-1.5 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded"><i class="ph ph-trash text-lg"></i></button>
                                </div>
                            </div>

                            <!-- å±•å¼€çš„å­ä»»åŠ¡ -->
                            <transition name="slide">
                                <div v-if="task.expanded" class="bg-slate-50 border-t border-slate-100 px-4 py-3 ml-[0] md:ml-[3.5rem]" @click.stop>
                                    <div class="space-y-2">
                                        <div v-for="(sub, idx) in task.subtasks" :key="idx" class="flex items-start gap-2">
                                            <label class="flex items-center gap-2 cursor-pointer select-none flex-1">
                                                <input type="checkbox" :checked="sub.status === 'done'" @change="toggleSubtask(task, sub)" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                                <span class="text-sm text-slate-700 transition-all" :class="{'line-through text-slate-400': sub.status === 'done'}">{{ sub.title }}</span>
                                            </label>
                                            <button @click="task.subtasks.splice(idx,1)" class="text-slate-300 hover:text-red-500"><i class="ph ph-x"></i></button>
                                        </div>
                                        <div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200 border-dashed"><i class="ph ph-plus text-slate-400 text-xs"></i><input type="text" placeholder="æ·»åŠ å­æ­¥éª¤..." @keydown.enter="addInlineSubtask(task, $event)" class="bg-transparent text-xs w-full focus:outline-none text-slate-600 placeholder-slate-400"></div>
                                    </div>
                                </div>
                            </transition>
                        </div>

                        <!-- å·²å®Œæˆä»»åŠ¡ -->
                        <div v-if="completedTasks.length > 0" class="pt-8 pb-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ph-bold ph-archive"></i> å·²å®Œæˆ <div class="h-px bg-slate-200 flex-1"></div></h3>
                            <div class="space-y-2">
                                <div v-for="task in completedTasks" :key="task.id" @click="selectTask(task)" class="task-card bg-slate-50 border border-slate-200 rounded-lg p-3 flex items-center gap-3 cursor-pointer hover:bg-white transition-all" :class="{'active': activeTask && activeTask.id === task.id, 'opacity-60 grayscale': (!activeTask || activeTask.id !== task.id)}">
                                    <button @click.stop="task.status = 'doing'; updateStatus(task)" class="text-green-600 hover:text-green-700"><i class="ph-fill ph-check-circle text-xl"></i></button>
                                    <div class="flex-1"><div class="text-sm line-through text-slate-500 font-medium">{{ task.title }}</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- View B: æ¨¡æ¿åº“ -->
                <template v-if="currentView === 'templates'">
                    <header class="h-16 bg-white/90 backdrop-blur px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                        <div><h2 class="text-lg font-bold text-purple-800">ä»»åŠ¡æ¨¡æ¿åº“</h2><div class="text-xs text-slate-500">é¢„è®¾å¸¸ç”¨ä»»åŠ¡</div></div>
                        <button @click="openModal()" class="h-9 px-4 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-bold shadow-md shadow-purple-200 flex items-center gap-2"><i class="ph ph-plus-bold"></i> æ–°å»º</button>
                    </header>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-20">
                        <div v-if="templates.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-copy text-4xl mb-2 text-purple-200"></i><p class="text-sm">æš‚æ— æ¨¡æ¿</p></div>
                        <div v-for="tmpl in templates" :key="tmpl.id" @click="selectTask(tmpl)" class="task-card template-card bg-white rounded-xl shadow-sm border border-slate-200 p-3 flex items-center gap-3 cursor-pointer relative" :class="{'active': activeTask && activeTask.id === tmpl.id}">
                            <div class="font-bold text-slate-800 text-sm flex-1">{{ tmpl.title }}</div>
                            <div class="flex items-center gap-1"><button @click.stop="openModal(tmpl)" class="p-1.5 text-slate-300 hover:text-purple-600 rounded"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(tmpl.id)" class="p-1.5 text-slate-300 hover:text-red-600 rounded"><i class="ph ph-trash text-lg"></i></button></div>
                        </div>
                    </div>
                </template>

                <!-- View C: å®šæ—¶ä»»åŠ¡ -->
                <template v-if="currentView === 'scheduled'">
                    <header class="h-16 bg-white/90 backdrop-blur px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                        <div><h2 class="text-lg font-bold text-teal-800">å®šæ—¶ä»»åŠ¡</h2><div class="text-xs text-slate-500">è‡ªåŠ¨é‡å¤ç”Ÿæˆçš„ä»»åŠ¡</div></div>
                        <button @click="openModal()" class="h-9 px-4 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-bold shadow-md shadow-teal-200 flex items-center gap-2"><i class="ph ph-plus-bold"></i> æ–°å»º</button>
                    </header>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-20">
                        <div v-if="scheduledTasks.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-clock-countdown text-4xl mb-2 text-teal-200"></i><p class="text-sm">æš‚æ— å®šæ—¶ä»»åŠ¡</p></div>
                        <div v-for="sch in scheduledTasks" :key="sch.id" @click="selectTask(sch)" class="task-card scheduled-card bg-white rounded-xl shadow-sm border border-slate-200 p-3 flex items-center gap-3 cursor-pointer" :class="{'active': activeTask && activeTask.id === sch.id, 'disabled': !sch.enabled}">
                            <label class="relative inline-flex items-center cursor-pointer shrink-0" @click.stop><input type="checkbox" v-model="sch.enabled" class="sr-only peer"><div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-teal-600"></div></label>
                            <div class="font-bold text-slate-800 text-sm flex-1" :class="{'text-slate-400': !sch.enabled}">{{ sch.title }}</div>
                            <div class="flex gap-1"><span v-for="d in formatRepeatDays(sch.repeatDays)" class="bg-teal-50 text-teal-600 text-[10px] px-1.5 py-0.5 rounded font-bold border border-teal-100">{{ d }}</span></div>
                            <button @click.stop="openModal(sch)" class="p-1.5 text-slate-300 hover:text-teal-600 rounded"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button @click.stop="deleteTask(sch.id)" class="p-1.5 text-slate-300 hover:text-red-600 rounded"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </div>
                </template>

                <!-- View D: æ•°æ®ç»Ÿè®¡ (ğŸŸ¢ ä¿®å¤2: å¢åŠ  min-h-0 å’Œ padding-bottomï¼Œç¡®ä¿å¯æ»šåŠ¨) -->
                <template v-if="currentView === 'statistics'">
                    <header class="h-auto md:h-16 bg-white/90 backdrop-blur px-4 md:px-6 flex flex-col md:flex-row justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0 py-2 gap-2">
                        <div><h2 class="text-lg font-bold text-indigo-800">æ•°æ®ç»Ÿè®¡</h2></div>

                        <div class="flex flex-wrap items-center gap-2 justify-center">
                            <select v-model="statsStatus" class="text-xs border border-slate-200 rounded px-2 py-1.5 outline-none bg-white text-slate-600 font-bold">
                                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="done">å·²å®Œæˆ</option>
                                <option value="incomplete">æœªå®Œæˆ (æœªå¼€å§‹+è¿›è¡Œä¸­)</option>
                                <option value="doing">è¿›è¡Œä¸­</option>
                                <option value="todo">æœªå¼€å§‹</option>
                            </select>

                            <div class="h-4 w-px bg-slate-200 hidden md:block"></div>

                            <div class="flex bg-slate-100 p-1 rounded-lg gap-1 overflow-x-auto max-w-[200px] md:max-w-none scrollbar-hide">
                                <button @click="setStatsRange('today')" class="px-2 py-1 text-[10px] rounded hover:bg-white hover:shadow-sm transition whitespace-nowrap" :class="statsRangeType==='today'?'bg-white shadow-sm font-bold text-indigo-600':'text-slate-500'">ä»Šæ—¥</button>
                                <button @click="setStatsRange('yesterday')" class="px-2 py-1 text-[10px] rounded hover:bg-white hover:shadow-sm transition whitespace-nowrap" :class="statsRangeType==='yesterday'?'bg-white shadow-sm font-bold text-indigo-600':'text-slate-500'">æ˜¨æ—¥</button>
                                <button @click="setStatsRange('week')" class="px-2 py-1 text-[10px] rounded hover:bg-white hover:shadow-sm transition whitespace-nowrap" :class="statsRangeType==='week'?'bg-white shadow-sm font-bold text-indigo-600':'text-slate-500'">æœ¬å‘¨</button>
                                <button @click="setStatsRange('lastWeek')" class="px-2 py-1 text-[10px] rounded hover:bg-white hover:shadow-sm transition whitespace-nowrap" :class="statsRangeType==='lastWeek'?'bg-white shadow-sm font-bold text-indigo-600':'text-slate-500'">ä¸Šå‘¨</button>
                                <button @click="setStatsRange('month')" class="px-2 py-1 text-[10px] rounded hover:bg-white hover:shadow-sm transition whitespace-nowrap" :class="statsRangeType==='month'?'bg-white shadow-sm font-bold text-indigo-600':'text-slate-500'">æœ¬æœˆ</button>
                                <button @click="setStatsRange('lastMonth')" class="px-2 py-1 text-[10px] rounded hover:bg-white hover:shadow-sm transition whitespace-nowrap" :class="statsRangeType==='lastMonth'?'bg-white shadow-sm font-bold text-indigo-600':'text-slate-500'">ä¸Šæœˆ</button>
                            </div>

                            <div class="flex items-center gap-1 bg-white border border-slate-200 rounded-md px-2 py-0.5">
                                <input type="date" v-model="statsStart" @change="statsRangeType='custom'" class="text-[10px] outline-none text-slate-500 w-20">
                                <span class="text-slate-300">-</span>
                                <input type="date" v-model="statsEnd" @change="statsRangeType='custom'" class="text-[10px] outline-none text-slate-500 w-20">
                            </div>
                        </div>
                    </header>
                    <!-- å¢åŠ äº† min-h-0 å’Œ pb-32ï¼Œç¡®ä¿æ‰‹æœºä¸Šèƒ½æ»šåŠ¨ä¸”ä¸è¢«åº•éƒ¨å¯¼èˆªé®æŒ¡ -->
                    <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 pb-32 min-h-0">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase mb-1">æ€»ä»»åŠ¡</div><div class="text-3xl font-black text-slate-700">{{ statsData.total }}</div></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-green-500 uppercase mb-1">å·²å®Œæˆ</div><div class="text-3xl font-black text-green-600">{{ statsData.done }} <span class="text-sm font-medium text-slate-400">({{ statsData.rate }}%)</span></div></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-blue-500 uppercase mb-1">è¿›è¡Œä¸­</div><div class="text-3xl font-black text-blue-600">{{ statsData.doing }}</div></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-gray-500 uppercase mb-1">æœªå¼€å§‹</div><div class="text-3xl font-black text-gray-600">{{ statsData.todo }}</div></div>
                        </div>

                        <!-- æ‰‹æœºç«¯ç»Ÿè®¡è§†å›¾ (å¡ç‰‡å¼) -->
                        <div class="md:hidden space-y-3">
                            <div class="px-2 text-xs font-bold text-slate-400">ä»»åŠ¡æ˜ç»† ({{ statsStart }} ~ {{ statsEnd }})</div>
                            <div v-if="statsData.list.length === 0" class="text-center py-8 text-slate-400 text-sm">æš‚æ— æ•°æ®</div>
                            <div v-for="t in statsData.list" :key="t.id" @click="selectTask(t)" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col gap-2 active:scale-[0.98] transition-transform">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-slate-800 text-sm truncate flex-1">{{ t.title }}</div>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold shrink-0 ml-2" :class="getStatsStatusStyle(t)">{{ getStatsStatusLabel(t) }}</span>
                                </div>
                                <div class="flex justify-between items-center text-[10px] text-slate-400">
                                    <div class="flex gap-2">
                                        <span :class="{'text-red-500 font-bold': isOverdue(t)}">æˆªæ­¢: {{ formatDateTime(t.deadline) || '-' }}</span>
                                    </div>
                                    <div class="font-mono">
                                        <span v-if="t.completedDate" class="text-green-600">å®Œ: {{ formatDateTime(t.completedDate).split(' ')[0] }}</span>
                                        <span v-else class="text-slate-300">æœªå®Œæˆ</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç»Ÿè®¡è¡¨æ ¼ (ç”µè„‘ç«¯) -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden hidden md:block">
                            <div class="px-6 py-4 border-b border-slate-50 font-bold text-slate-700">ä»»åŠ¡æ˜ç»† ({{ statsStart }} ~ {{ statsEnd }})</div>
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500"><tr><th class="px-6 py-3">åç§°</th><th class="px-6 py-3">çŠ¶æ€</th><th class="px-6 py-3">è®¡åˆ’ä¸æˆªæ­¢</th><th class="px-6 py-3">å¼€å§‹ä¸ç»“æŸ</th></tr></thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr v-for="t in statsData.list" :key="t.id" @click="selectTask(t)" class="hover:bg-slate-50 cursor-pointer">
                                        <td class="px-6 py-3 font-bold text-slate-700">{{ t.title }}</td>
                                        <td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs font-bold" :class="getStatsStatusStyle(t)">{{ getStatsStatusLabel(t) }}</span></td>
                                        <td class="px-6 py-3 text-xs"><div class="text-slate-600">{{ formatDateTime(t.date) }}</div><div :class="isOverdue(t)?'text-red-500':'text-slate-400'">{{ formatDateTime(t.deadline)||'-' }}</div></td>
                                        <td class="px-6 py-3 text-xs"><div class="text-blue-600">{{ t.startTime?formatDateTime(t.startTime):'-' }}</div><div class="text-green-600">{{ t.completedDate?formatDateTime(t.completedDate):'-' }}</div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>
            </main>

            <!-- å³ä¾§è¯¦æƒ…æ  (ç”µè„‘ç«¯) -->
            <aside class="hidden md:flex w-[350px] bg-white border-l border-slate-200 flex-col z-10 shrink-0 h-full shadow-[-4px_0_15px_rgba(0,0,0,0.02)]">
                <div class="h-16 border-b border-slate-100 flex items-center px-6 bg-slate-50/80">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph ph-sliders-horizontal"></i> ä»»åŠ¡è¯¦æƒ…</h3>
                </div>
                <div v-if="activeTask" class="flex-1 overflow-y-auto p-6 flex flex-col h-full">
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] font-mono uppercase px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">{{ activeTask.id.slice(-4) }}</span>
                            <span v-if="isOverdue(activeTask) && currentView === 'dashboard'" class="text-[10px] font-bold px-2 py-0.5 rounded bg-red-100 text-red-600">å·²è¶…æ—¶</span>
                        </div>
                        <h2 class="text-2xl font-black text-slate-800 leading-snug">{{ activeTask.title }}</h2>
                    </div>
                    <div class="flex-1 flex flex-col mb-6 min-h-[150px]">
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2">å¤‡æ³¨ / ç¬”è®°</label>
                        <textarea v-model="activeTask.note" placeholder="è¾“å…¥å†…å®¹..." class="flex-1 w-full bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-sm text-slate-700 leading-relaxed focus:outline-none focus:ring-2 focus:ring-yellow-300 resize-none font-mono"></textarea>
                    </div>
                    <div class="mb-6 bg-slate-50 rounded-xl p-4 border border-slate-100">
                        <div class="text-xs font-bold text-slate-500 uppercase mb-2">å­ä»»åŠ¡</div>
                        <ul class="space-y-1">
                            <li v-for="sub in activeTask.subtasks" class="text-xs flex items-center gap-2"><i :class="sub.status==='done' ? 'ph-fill ph-check-circle text-green-500' : 'ph ph-circle text-slate-300'"></i><span :class="{'line-through text-slate-400': sub.status==='done', 'text-slate-600': sub.status!=='done'}">{{ sub.title }}</span></li>
                            <li v-if="!activeTask.subtasks || activeTask.subtasks.length===0" class="text-xs text-slate-400 italic">æ— å­ä»»åŠ¡</li>
                        </ul>
                    </div>
                    <div class="border-t border-slate-100 pt-4 grid grid-cols-2 gap-4 text-xs">
                        <div>
                            <div class="text-slate-400 mb-1">è®¡åˆ’æ—¥æœŸ</div>
                            <div class="font-bold text-slate-700">{{ formatDateTime(activeTask.date) }}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 mb-1">æˆªæ­¢æ—¶é—´</div>
                            <div class="font-bold" :class="isOverdue(activeTask)?'text-red-500':'text-slate-700'">{{ formatDateTime(activeTask.deadline) || '-' }}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 mb-1">å¼€å§‹æ—¶é—´</div>
                            <div class="font-bold text-blue-600">{{ activeTask.startTime ? formatDateTime(activeTask.startTime) : '-' }}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 mb-1">å®Œæˆæ—¶é—´</div>
                            <div class="font-bold text-green-600">{{ activeTask.completedDate ? formatDateTime(activeTask.completedDate) : '-' }}</div>
                        </div>
                    </div>
                </div>
                <div v-else class="h-full flex flex-col items-center justify-center text-center opacity-40 p-10"><i class="ph ph-hand-tap text-5xl text-slate-300 mb-4"></i><h4 class="font-bold text-slate-600 text-lg">ç‚¹å‡»åˆ—è¡¨é¡¹</h4></div>
            </aside>

            <!-- === ğŸ“± æ‰‹æœºç«¯ä¸“å±ï¼šä»»åŠ¡è¯¦æƒ…æµ®å±‚ (ç‚¹å‡»ä»»åŠ¡åæ»‘å‡º) === -->
            <div v-if="activeTask" class="mobile-detail-overlay md:hidden">
                <!-- å¤´éƒ¨ï¼šè¿”å›æŒ‰é’® + æ ‡é¢˜ -->
                <div class="h-14 border-b border-slate-100 flex items-center justify-between px-4 bg-white shrink-0">
                    <button @click="activeTask = null" class="text-slate-500 flex items-center gap-1 font-bold">
                        <i class="ph-bold ph-caret-left text-lg"></i> è¿”å›
                    </button>
                    <div class="text-xs font-mono text-slate-400 bg-slate-100 px-2 py-1 rounded">ID: {{ activeTask.id.slice(-4) }}</div>
                    <div class="flex gap-3">
                        <button v-if="currentView !== 'scheduled'" @click="activeTask.status = 'done'; updateStatus(activeTask); activeTask = null" class="text-green-600"><i class="ph-fill ph-check-circle text-2xl"></i></button>
                        <button @click="deleteTask(activeTask.id)" class="text-red-500"><i class="ph-bold ph-trash text-xl"></i></button>
                    </div>
                </div>

                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="flex-1 overflow-y-auto p-5 space-y-6 pb-24 bg-slate-50/50">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span v-if="isOverdue(activeTask)" class="text-[10px] font-bold px-2 py-0.5 rounded bg-red-100 text-red-600 border border-red-200">å·²è¶…æ—¶</span>
                            <span v-if="activeTask.priority === 'urgent'" class="text-[10px] font-bold px-2 py-0.5 rounded bg-orange-100 text-orange-600">ç´§æ€¥</span>
                            <span v-if="activeTask.priority === 'critical'" class="text-[10px] font-bold px-2 py-0.5 rounded bg-red-100 text-red-600">ç‰¹æ€¥</span>
                        </div>
                        <h2 class="text-2xl font-black text-slate-800 leading-snug">{{ activeTask.title }}</h2>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">å¤‡æ³¨ / ç¬”è®°</label>
                        <textarea v-model="activeTask.note" rows="5" placeholder="ç‚¹å‡»è¾“å…¥å†…å®¹..." class="w-full text-sm text-slate-700 leading-relaxed focus:outline-none resize-none font-mono placeholder-slate-300"></textarea>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-3 block flex justify-between">
                            å­ä»»åŠ¡æ¸…å•
                            <span class="text-blue-500" @click="openModal(activeTask)">å»ç¼–è¾‘</span>
                        </label>
                        <ul class="space-y-3">
                            <li v-for="sub in activeTask.subtasks" :key="sub.title" class="text-sm flex items-start gap-3">
                                <i :class="sub.status==='done' ? 'ph-fill ph-check-circle text-green-500 text-lg' : 'ph ph-circle text-slate-300 text-lg'"></i>
                                <span :class="{'line-through text-slate-400': sub.status==='done', 'text-slate-700': sub.status!=='done'}" class="flex-1 leading-snug">{{ sub.title }}</span>
                            </li>
                            <li v-if="!activeTask.subtasks || activeTask.subtasks.length===0" class="text-sm text-slate-400 italic text-center py-2">æ— å­ä»»åŠ¡</li>
                        </ul>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-3 rounded-lg border border-slate-100"><div class="text-xs text-slate-400 mb-1">è®¡åˆ’æ—¥æœŸ</div><div class="font-bold text-slate-700">{{ formatDateTime(activeTask.date) }}</div></div>
                        <div class="bg-white p-3 rounded-lg border border-slate-100"><div class="text-xs text-slate-400 mb-1">æˆªæ­¢æ—¶é—´</div><div class="font-bold" :class="isOverdue(activeTask)?'text-red-500':'text-slate-700'">{{ formatDateTime(activeTask.deadline) || 'æ— ' }}</div></div>
                        <div class="bg-white p-3 rounded-lg border border-slate-100"><div class="text-xs text-slate-400 mb-1">å¼€å§‹æ—¶é—´</div><div class="font-bold text-blue-600">{{ activeTask.startTime ? formatDateTime(activeTask.startTime) : '-' }}</div></div>
                        <div class="bg-white p-3 rounded-lg border border-slate-100"><div class="text-xs text-slate-400 mb-1">å®Œæˆæ—¶é—´</div><div class="font-bold text-green-600">{{ activeTask.completedDate ? formatDateTime(activeTask.completedDate) : '-' }}</div></div>
                    </div>
                </div>

                <div class="absolute bottom-6 right-6 z-10">
                    <button @click="openModal(activeTask)" class="w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-300 flex items-center justify-center active:scale-90 transition-transform">
                        <i class="ph-bold ph-pencil-simple text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
            <nav class="mobile-nav-bar md:hidden">
                <button @click="switchView('dashboard')" class="mobile-nav-item" :class="currentView === 'dashboard' ? 'active' : ''"><i class="ph ph-sun"></i>çœ‹æ¿</button>
                <button @click="switchView('templates')" class="mobile-nav-item" :class="currentView === 'templates' ? 'active' : ''"><i class="ph ph-copy"></i>æ¨¡æ¿</button>
                <button @click="switchView('scheduled')" class="mobile-nav-item" :class="currentView === 'scheduled' ? 'active' : ''"><i class="ph ph-clock-countdown"></i>å®šæ—¶</button>
                <button @click="switchView('statistics')" class="mobile-nav-item" :class="currentView === 'statistics' ? 'active' : ''"><i class="ph ph-chart-bar"></i>ç»Ÿè®¡</button>
            </nav>

            <!-- æ¨¡æ€æ¡† (ç¼–è¾‘/æ–°å»º) -->
            <div v-if="modal.show" class="fixed inset-0 z-50 flex items-center justify-center p-4 mobile-modal-container">
                <div @click="modal.show = false" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative flex flex-col max-h-[90vh] overflow-hidden transform transition-all mobile-bottom-sheet">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg text-slate-800">{{ modal.isEdit ? 'ç¼–è¾‘' : 'æ–°å»º' }}</h3><button @click="modal.show = false"><i class="ph ph-x text-xl"></i></button></div>
                    <div class="p-6 overflow-y-auto space-y-5">
                        <div v-if="currentView === 'dashboard' && !modal.isEdit && templates.length > 0" class="bg-purple-50 border border-purple-100 rounded-lg p-3">
                            <select @change="loadTemplate($event)" class="w-full bg-white border border-purple-200 rounded px-2 py-1.5 text-sm text-slate-700"><option value="">-- å¿«é€ŸåŠ è½½æ¨¡æ¿ --</option><option v-for="t in templates" :key="t.id" :value="t.id">{{ t.title }}</option></select>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">åç§°</label><input v-model="modal.data.title" type="text" class="w-full text-lg font-bold border-b-2 border-slate-200 py-1 focus:border-blue-500 outline-none" placeholder="è¾“å…¥åç§°"></div>
                        <div v-if="currentView === 'scheduled'" class="bg-teal-50 p-4 rounded-xl"><label class="text-xs font-bold text-teal-700 uppercase mb-2 block">é‡å¤å‘¨æœŸ</label><div class="flex justify-between gap-1"><label v-for="(dayStr, idx) in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="idx" class="cursor-pointer"><input type="checkbox" :value="idx === 6 ? 0 : idx + 1" v-model="modal.data.repeatDays" class="hidden peer"><span class="block w-8 h-8 rounded-full border border-teal-200 bg-white text-center leading-8 text-sm text-slate-500 peer-checked:bg-teal-500 peer-checked:text-white transition-all">{{ dayStr }}</span></label></div></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">å¤‡æ³¨</label><textarea v-model="modal.data.note" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm resize-none"></textarea></div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <div class="space-y-2">
                                <div v-for="(sub, index) in modal.data.subtasks" :key="index" class="flex gap-2 items-center group" draggable="true" @dragstart="dragStart(index, $event)" @drop="dragDrop(index)" @dragover.prevent><i class="ph-bold ph-dots-six-vertical text-slate-300 cursor-move"></i><input v-model="sub.title" class="flex-1 bg-white border border-slate-200 rounded px-2 py-1 text-sm"><button @click="modal.data.subtasks.splice(index, 1)"><i class="ph-bold ph-trash text-slate-400"></i></button></div>
                                <div class="flex gap-2"><input type="text" ref="newSubInput" placeholder="æ–°å­ä»»åŠ¡..." @keydown.enter="addModalSubtask" class="flex-1 bg-transparent border-b border-slate-300 px-2 py-1 text-sm outline-none"><button @click="addModalSubtask" class="text-blue-600 text-sm font-bold">æ·»åŠ </button></div>
                            </div>
                        </div>
                        <div v-if="currentView === 'dashboard'" class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-slate-500 uppercase">è®¡åˆ’</label><input type="datetime-local" v-model="modal.data.date" class="w-full border border-slate-200 rounded px-2 py-2 text-sm"></div><div><label class="text-xs font-bold text-slate-500 uppercase">æˆªæ­¢</label><input type="datetime-local" v-model="modal.data.deadline" class="w-full border border-slate-200 rounded px-2 py-2 text-sm"></div></div>
                    </div>
                    <div class="p-4 border-t border-slate-100 flex justify-end gap-3 bg-white">
                        <button @click="modal.show = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                        <button @click="saveTask" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow">ç¡®è®¤</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- ä¸šåŠ¡é€»è¾‘ -->
    <script src="script.js"></script>
</body>
</html>