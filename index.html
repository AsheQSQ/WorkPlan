<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanProMax - åŒé±¼å°å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        body {
            background-color: #f1f5f9;
            font-family: 'Segoe UI', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-card {
            transition: all 0.2s ease;
            border-left-width: 4px;
            border-left-color: transparent;
        }

            .task-card.active {
                border-left-color: #2563eb;
                background-color: #eff6ff;
                border-color: #bfdbfe;
                transform: scale-[1.005];
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

        .future-card {
            border-style: dashed;
            border-left-style: solid;
            opacity: 0.8;
        }

            .future-card.active {
                border-left-color: #0d9488;
                background-color: #f0fdfa;
                border-color: #99f6e4;
            }

        .template-card.active {
            border-left-color: #9333ea;
            background-color: #faf5ff;
            border-color: #e9d5ff;
        }

        .scheduled-card.active {
            border-left-color: #0d9488;
            background-color: #f0fdfa;
            border-color: #ccfbf1;
        }

        .scheduled-card.disabled {
            opacity: 0.6;
            background-color: #f8fafc;
            border-left-color: #cbd5e1;
        }

        .slide-enter-active, .slide-leave-active {
            transition: all 0.3s ease;
            max-height: 500px;
            opacity: 1;
            overflow: hidden;
        }

        .slide-enter-from, .slide-leave-to {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
        }

        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .dragging {
            opacity: 0.5;
            background-color: #f1f5f9;
            border: 1px dashed #cbd5e1;
        }

        /* ç¦æ­¢é€‰æ‹©æ–‡æœ¬ï¼Œç”¨äºæ¨¡æ‹ŸæŒ‰é’®ä½“éªŒ */
        .select-none {
            user-select: none;
        }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen flex flex-col md:flex-row overflow-hidden text-slate-800">

    <!-- 1. å·¦ä¾§å¯¼èˆª -->
    <aside class="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg shrink-0">
        <div class="p-6 flex items-center gap-3 border-b border-slate-100 h-16">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                <i class="ph ph-check-square-offset text-xl"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-slate-800">PlanProMax_ZY</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button @click="switchView('dashboard')" 
                class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold"
                :class="currentView === 'dashboard' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'">
                <i class="ph ph-sun text-lg"></i> ä»Šæ—¥çœ‹æ¿
                <span v-if="activeTasks.length > 0" class="ml-auto bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">{{ activeTasks.length }}</span>
            </button>

            <button @click="switchView('templates')" 
                class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold"
                :class="currentView === 'templates' ? 'bg-purple-50 text-purple-700' : 'text-slate-600 hover:bg-slate-50'">
                <i class="ph ph-copy text-lg"></i> ä»»åŠ¡æ¨¡æ¿
            </button>

            <button @click="switchView('scheduled')" 
                class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold"
                :class="currentView === 'scheduled' ? 'bg-teal-50 text-teal-700' : 'text-slate-600 hover:bg-slate-50'">
                <i class="ph ph-clock-countdown text-lg"></i> å®šæ—¶ä»»åŠ¡
                <span v-if="enabledScheduledCount > 0" class="ml-auto bg-teal-100 text-teal-700 text-[10px] px-2 py-0.5 rounded-full">{{ enabledScheduledCount }}</span>
            </button>

            <button @click="switchView('statistics')" 
                class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-bold"
                :class="currentView === 'statistics' ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-slate-50'">
                <i class="ph ph-chart-bar text-lg"></i> æ•°æ®ç»Ÿè®¡
            </button>
        </nav>

        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">æ•°æ®ç®¡ç†</div>
            <div class="grid grid-cols-4 gap-2">
                <button @click="exportData" class="col-span-2 flex items-center justify-center gap-1 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition shadow-sm">
                    <i class="ph ph-download-simple"></i> å¤‡ä»½
                </button>
                <button @click="$refs.fileInput.click()" class="col-span-2 flex items-center justify-center gap-1 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition shadow-sm">
                    <i class="ph ph-upload-simple"></i> æ¢å¤
                </button>
                <button @click="handleOpenPath" class="col-span-2 flex items-center justify-center gap-1 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 hover:bg-slate-100 hover:text-orange-600 transition shadow-sm">
                    <i class="ph ph-info"></i> ä¿¡æ¯
                </button>
                <button @click="handleClearData" class="col-span-2 flex items-center justify-center gap-1 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-600 hover:bg-red-50 hover:text-red-600 transition shadow-sm">
                    <i class="ph ph-trash"></i> æ¸…ç©º
                </button>
                <input type="file" ref="fileInput" @change="importData" class="hidden" accept=".json">
            </div>
        </div>
    </aside>

    <!-- 2. ä¸­é—´ï¼šä¸»å†…å®¹åŒº -->
    <main class="flex-1 flex flex-col relative bg-[#f1f5f9] min-w-0 border-r border-slate-200">

        <!-- è§†å›¾ A: ä»Šæ—¥çœ‹æ¿ -->
        <template v-if="currentView === 'dashboard'">
            <header class="h-16 bg-white/90 backdrop-blur px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                <div class="flex items-center gap-3">
                    <button @click="changeDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 text-slate-600 transition"><i class="ph-bold ph-caret-left"></i></button>
                    <div class="flex flex-col items-center">
                        <div class="relative group">
                            <input type="date" v-model="viewDate" class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-1 cursor-pointer group-hover:text-blue-600">{{ dateInfo.date }} <i class="ph-fill ph-caret-down text-xs text-slate-400"></i></h2>
                        </div>
                        <div class="text-xs text-slate-500 font-medium">{{ dateInfo.week }}</div>
                    </div>
                    <button @click="changeDate(1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-200 text-slate-600 transition"><i class="ph-bold ph-caret-right"></i></button>
                    <button v-if="viewDate !== today" @click="resetToToday" class="ml-2 text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-md font-bold hover:bg-blue-100 transition">å›åˆ°ä»Šå¤©</button>
                </div>
                <div class="flex items-center gap-3">
                    <div v-if="overdueCount > 0 && viewDate === today" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 flex items-center gap-1 mr-2">
                        <i class="ph-fill ph-warning"></i> {{ overdueCount }} è¶…æ—¶
                    </div>
                    <button @click="toggleAll" class="h-9 px-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-sm">
                        <i :class="isAllExpanded ? 'ph ph-arrows-in-line-vertical' : 'ph ph-arrows-out-line-vertical'"></i><span class="hidden sm:inline">{{ isAllExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}</span>
                    </button>
                    <button @click="openModal()" class="h-9 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md shadow-blue-200 flex items-center gap-2 transition active:scale-95">
                        <i class="ph ph-plus-bold"></i> <span class="hidden sm:inline">æ–°å»º</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
                <div v-if="futurePreviews.length > 0" class="mb-6">
                    <h3 class="text-xs font-bold text-teal-600 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-calendar-plus"></i> å¾…è‡ªåŠ¨ç”Ÿæˆ ({{ futurePreviews.length }})
                        <div class="h-px bg-teal-100 flex-1"></div>
                    </h3>
                    <div v-for="task in futurePreviews" :key="task.id" @click="selectTask(task)" class="task-card future-card bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-3 flex items-center gap-3 cursor-pointer group hover:bg-white transition-colors" :class="{'active': activeTask && activeTask.id === task.id}">
                        <div class="w-6 flex justify-center text-slate-300"><i class="ph-bold ph-clock-countdown text-lg"></i></div>
                        <div class="relative w-24 shrink-0 pointer-events-none opacity-70"><div class="w-full py-1.5 rounded-lg text-xs font-bold border text-center bg-white" :class="getPriorityStyle(task.priority)">{{ {normal:'æ™®é€š', urgent:'ç´§æ€¥', critical:'ç‰¹æ€¥'}[task.priority] }}</div></div>
                        <div class="font-bold text-slate-600 text-sm">{{ task.title }}</div><div class="flex-1 text-[10px] text-slate-400 italic ml-2">å°†åœ¨ {{ viewDate }} è‡ªåŠ¨åˆ›å»º</div>
                    </div>
                </div>

                <div v-if="activeTasks.length === 0 && completedTasks.length === 0 && futurePreviews.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-coffee text-4xl mb-2"></i><p class="text-sm">{{ viewDate === today ? 'ä»Šæ—¥æ— ä»»åŠ¡' : 'å½“å¤©æ— å®‰æ’' }}</p></div>

                <div v-for="task in activeTasks" :key="task.id" @click="selectTask(task)" class="task-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === task.id}">
                    <div v-if="isOverdue(task)" class="absolute top-0 left-0 right-0 h-1 bg-red-500 z-10"></div>
                    <div v-else-if="isDueToday(task)" class="absolute top-0 left-0 right-0 h-1 bg-orange-400 z-10"></div>
                    <div class="p-3 flex items-center gap-3 relative z-0 h-16">
                        <button @click.stop="task.expanded = !task.expanded" class="shrink-0 text-slate-400 hover:text-blue-600 transition-transform duration-200 w-6" :class="{'rotate-90': task.expanded}"><i class="ph-bold ph-caret-right text-lg"></i></button>
                        <div class="relative w-24 shrink-0" @click.stop><select v-model="task.priority" class="w-full appearance-none pl-7 pr-2 py-1.5 rounded-lg text-xs font-bold border focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors cursor-pointer bg-white" :class="getPriorityStyle(task.priority)"><option value="normal">æ™®é€š</option><option value="urgent">ç´§æ€¥</option><option value="critical">ç‰¹æ€¥</option></select><div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"><i v-if="task.priority==='normal'" class="ph-fill ph-flag text-blue-500"></i><i v-if="task.priority==='urgent'" class="ph-fill ph-flag text-orange-500"></i><i v-if="task.priority==='critical'" class="ph-fill ph-flag text-red-500"></i></div></div>
                        <div class="relative w-28 shrink-0" @click.stop>
                            <select v-model="task.status" @change="updateStatus(task)" class="w-full appearance-none pl-7 pr-2 py-1.5 rounded-lg text-xs font-bold border focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors cursor-pointer bg-white" :class="getStatusStyle(task.status)">
                                <option value="todo">æœªå¼€å§‹</option>
                                <option value="doing">è¿›è¡Œä¸­</option>
                                <option value="done">å·²å®Œæˆ</option>
                            </select>
                            <div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none">
                                <i v-if="task.status==='todo'" class="ph ph-circle text-slate-400"></i>
                                <i v-if="task.status==='doing'" class="ph ph-spinner animate-spin text-blue-600"></i>
                                <i v-if="task.status==='done'" class="ph ph-check-circle text-green-600"></i>
                            </div>
                        </div>
                        <div class="font-bold text-slate-800 text-sm whitespace-nowrap shrink-0 flex items-center gap-2">{{ task.title }}<span class="text-[10px] font-normal text-slate-400 font-mono bg-slate-100 px-1 rounded">{{ formatTimeOnly(task.date) }}</span><span v-if="isOverdue(task)" class="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold border border-red-200">è¶…æ—¶</span></div>
                        <div class="flex-1 min-w-0 border-l border-slate-200 pl-3 ml-1"><div v-if="task.note" class="text-xs text-slate-400 truncate font-mono">{{ getLatestNoteLine(task.note) }}</div><div v-else class="text-[10px] text-slate-300 italic truncate">æ— æè¿°</div></div>
                        <div class="flex items-center gap-1 ml-2"><button @click.stop="openModal(task)" class="shrink-0 text-slate-300 hover:text-blue-600 p-1.5 rounded hover:bg-blue-50 transition"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(task.id)" class="shrink-0 text-slate-300 hover:text-red-600 p-1.5 rounded hover:bg-red-50 transition"><i class="ph ph-trash text-lg"></i></button></div>
                    </div>
                    <transition name="slide"><div v-if="task.expanded" class="bg-slate-50 border-t border-slate-100 px-4 py-3 ml-[3.5rem]" @click.stop><div class="space-y-2">
                        <div v-for="(sub, idx) in task.subtasks" :key="idx" class="flex items-start gap-2">
                            <label class="flex items-center gap-2 cursor-pointer select-none flex-1">
                                <input type="checkbox" :checked="sub.status === 'done'" @change="toggleSubtask(task, sub)" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                                <span class="text-sm text-slate-700 transition-all" :class="{'line-through text-slate-400': sub.status === 'done'}">{{ sub.title }}</span>
                            </label>
                            <button @click="task.subtasks.splice(idx,1)" class="text-slate-300 hover:text-red-500"><i class="ph ph-x"></i></button>
                        </div>
                        <div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200 border-dashed"><i class="ph ph-plus text-slate-400 text-xs"></i><input type="text" placeholder="æ·»åŠ å­æ­¥éª¤..." @keydown.enter="addInlineSubtask(task, $event)" class="bg-transparent text-xs w-full focus:outline-none text-slate-600 placeholder-slate-400"></div></div></div></transition>
                </div>

                <div v-if="completedTasks.length > 0" class="pt-8 pb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ph-bold ph-archive"></i> å·²å®Œæˆ <div class="h-px bg-slate-200 flex-1"></div></h3>
                    <div class="space-y-2">
                        <div v-for="task in completedTasks" :key="task.id" @click="selectTask(task)" class="task-card bg-slate-50 border border-slate-200 rounded-lg p-3 flex items-center gap-3 cursor-pointer hover:bg-white transition-all" :class="{'active': activeTask && activeTask.id === task.id, 'opacity-60 grayscale': (!activeTask || activeTask.id !== task.id)}">
                            <button @click.stop="task.status = 'doing'; updateStatus(task)" class="text-green-600 hover:text-green-700"><i class="ph-fill ph-check-circle text-xl"></i></button>
                            <div class="flex-1"><div class="text-sm line-through text-slate-500 font-medium">{{ task.title }}</div><div class="text-[10px] text-slate-400">å½’æ¡£äº: {{ formatDateTime(task.completedDate) }}</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- è§†å›¾ B: ä»»åŠ¡æ¨¡æ¿ -->
        <template v-if="currentView === 'templates'">
            <header class="h-16 bg-white/90 backdrop-blur px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                <div><h2 class="text-lg font-bold text-purple-800">ä»»åŠ¡æ¨¡æ¿åº“</h2><div class="text-xs text-slate-500">é¢„è®¾å¸¸ç”¨ä»»åŠ¡</div></div>
                <button @click="openModal()" class="h-9 px-4 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-bold shadow-md shadow-purple-200 flex items-center gap-2 transition active:scale-95"><i class="ph ph-plus-bold"></i> æ–°å»ºæ¨¡æ¿</button>
            </header>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
                <div v-if="templates.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-copy text-4xl mb-2 text-purple-200"></i><p class="text-sm">æš‚æ— æ¨¡æ¿</p></div>
                <div v-for="tmpl in templates" :key="tmpl.id" @click="selectTask(tmpl)" class="task-card template-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === tmpl.id}">
                    <div class="p-3 flex items-center gap-3 relative z-0 h-16">
                        <button @click.stop="tmpl.expanded = !tmpl.expanded" class="shrink-0 text-slate-400 hover:text-purple-600 transition-transform duration-200 w-6" :class="{'rotate-90': tmpl.expanded}"><i class="ph-bold ph-caret-right text-lg"></i></button>
                        <div class="relative w-24 shrink-0" @click.stop><select v-model="tmpl.priority" class="w-full appearance-none pl-7 pr-2 py-1.5 rounded-lg text-xs font-bold border focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors cursor-pointer bg-white" :class="getPriorityStyle(tmpl.priority)"><option value="normal">æ™®é€š</option><option value="urgent">ç´§æ€¥</option><option value="critical">ç‰¹æ€¥</option></select><div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"><i v-if="tmpl.priority==='normal'" class="ph-fill ph-flag text-blue-500"></i><i v-if="tmpl.priority==='urgent'" class="ph-fill ph-flag text-orange-500"></i><i v-if="tmpl.priority==='critical'" class="ph-fill ph-flag text-red-500"></i></div></div>
                        <div class="font-bold text-slate-800 text-sm whitespace-nowrap shrink-0">{{ tmpl.title }}</div>
                        <span class="bg-purple-100 text-purple-600 text-[10px] px-1.5 py-0.5 rounded font-bold border border-purple-200">TEMPLATE</span>
                        <div class="flex-1 min-w-0 border-l border-slate-200 pl-3 ml-1"><div v-if="tmpl.note" class="text-xs text-slate-400 truncate font-mono">{{ getLatestNoteLine(tmpl.note) }}</div><div v-else class="text-[10px] text-slate-300 italic truncate">æ— é»˜è®¤å¤‡æ³¨</div></div>
                        <div class="flex items-center gap-1 ml-2"><button @click.stop="openModal(tmpl)" class="shrink-0 text-slate-300 hover:text-purple-600 p-1.5 rounded hover:bg-purple-50 transition"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(tmpl.id)" class="shrink-0 text-slate-300 hover:text-red-600 p-1.5 rounded hover:bg-red-50 transition"><i class="ph ph-trash text-lg"></i></button></div>
                    </div>
                    <transition name="slide"><div v-if="tmpl.expanded" class="bg-slate-50 border-t border-slate-100 px-4 py-3 ml-[3.5rem]" @click.stop><div class="space-y-2"><div v-for="(sub, idx) in tmpl.subtasks" :key="idx" class="flex items-start gap-2"><span class="flex-1 text-sm text-slate-600">{{ sub.title }}</span><button @click="tmpl.subtasks.splice(idx,1)" class="text-slate-300 hover:text-red-500"><i class="ph ph-x"></i></button></div><div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200 border-dashed"><i class="ph ph-plus text-slate-400 text-xs"></i><input type="text" placeholder="æ·»åŠ é»˜è®¤å­æ­¥éª¤..." @keydown.enter="addInlineSubtask(tmpl, $event)" class="bg-transparent text-xs w-full focus:outline-none text-slate-600 placeholder-slate-400"></div></div></div></transition>
                </div>
            </div>
        </template>

        <!-- è§†å›¾ C: å®šæ—¶ä»»åŠ¡ -->
        <template v-if="currentView === 'scheduled'">
            <header class="h-16 bg-white/90 backdrop-blur px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                <div><h2 class="text-lg font-bold text-teal-800">å®šæ—¶ä»»åŠ¡ç®¡ç†</h2><div class="text-xs text-slate-500">æ¯å‘¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨åŠ å…¥çœ‹æ¿</div></div>
                <button @click="openModal()" class="h-9 px-4 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-bold shadow-md shadow-teal-200 flex items-center gap-2 transition active:scale-95"><i class="ph ph-plus-bold"></i> æ–°å»ºå®šæ—¶</button>
            </header>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-smooth pb-20">
                <div v-if="scheduledTasks.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="ph ph-clock-countdown text-4xl mb-2 text-teal-200"></i><p class="text-sm">æš‚æ— å®šæ—¶ä»»åŠ¡</p></div>
                <div v-for="sch in scheduledTasks" :key="sch.id" @click="selectTask(sch)" class="task-card scheduled-card bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden cursor-pointer group" :class="{'active': activeTask && activeTask.id === sch.id, 'disabled': !sch.enabled}">
                    <div class="p-3 flex items-center gap-3 relative z-0 h-16">
                        <button @click.stop="sch.expanded = !sch.expanded" class="shrink-0 text-slate-400 hover:text-teal-600 transition-transform duration-200 w-6" :class="{'rotate-90': sch.expanded}"><i class="ph-bold ph-caret-right text-lg"></i></button>
                        <label class="relative inline-flex items-center cursor-pointer shrink-0" @click.stop><input type="checkbox" v-model="sch.enabled" class="sr-only peer"><div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-teal-600"></div></label>
                        <div class="relative w-24 shrink-0" @click.stop><select v-model="sch.priority" class="w-full appearance-none pl-7 pr-2 py-1.5 rounded-lg text-xs font-bold border focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors cursor-pointer bg-white" :class="getPriorityStyle(sch.priority)"><option value="normal">æ™®é€š</option><option value="urgent">ç´§æ€¥</option><option value="critical">ç‰¹æ€¥</option></select><div class="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none"><i v-if="sch.priority==='normal'" class="ph-fill ph-flag text-blue-500"></i><i v-if="sch.priority==='urgent'" class="ph-fill ph-flag text-orange-500"></i><i v-if="sch.priority==='critical'" class="ph-fill ph-flag text-red-500"></i></div></div>
                        <div class="font-bold text-slate-800 text-sm whitespace-nowrap shrink-0" :class="{'text-slate-400': !sch.enabled}">{{ sch.title }}</div>
                        <div class="flex gap-1"><span v-for="d in formatRepeatDays(sch.repeatDays)" class="bg-teal-50 text-teal-600 text-[10px] px-1.5 py-0.5 rounded font-bold border border-teal-100" :class="{'opacity-50': !sch.enabled}">{{ d }}</span></div>
                        <div class="flex-1 min-w-0 border-l border-slate-200 pl-3 ml-1"><div v-if="sch.note" class="text-xs text-slate-400 truncate font-mono">{{ getLatestNoteLine(sch.note) }}</div><div v-else class="text-[10px] text-slate-300 italic truncate">æ— é»˜è®¤å¤‡æ³¨</div></div>
                        <div class="flex items-center gap-1 ml-2"><button @click.stop="openModal(sch)" class="shrink-0 text-slate-300 hover:text-teal-600 p-1.5 rounded hover:bg-teal-50 transition"><i class="ph ph-pencil-simple text-lg"></i></button><button @click.stop="deleteTask(sch.id)" class="shrink-0 text-slate-300 hover:text-red-600 p-1.5 rounded hover:bg-red-50 transition"><i class="ph ph-trash text-lg"></i></button></div>
                    </div>
                    <transition name="slide"><div v-if="sch.expanded" class="bg-slate-50 border-t border-slate-100 px-4 py-3 ml-[3.5rem]" @click.stop><div class="space-y-2"><div v-for="(sub, idx) in sch.subtasks" :key="idx" class="flex items-start gap-2"><span class="flex-1 text-sm text-slate-600">{{ sub.title }}</span><button @click="sch.subtasks.splice(idx,1)" class="text-slate-300 hover:text-red-500"><i class="ph ph-x"></i></button></div><div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200 border-dashed"><i class="ph ph-plus text-slate-400 text-xs"></i><input type="text" placeholder="æ·»åŠ é»˜è®¤å­æ­¥éª¤..." @keydown.enter="addInlineSubtask(sch, $event)" class="bg-transparent text-xs w-full focus:outline-none text-slate-600 placeholder-slate-400"></div></div></div></transition>
                </div>
            </div>
        </template>

        <!-- è§†å›¾ D: æ•°æ®ç»Ÿè®¡ -->
        <template v-if="currentView === 'statistics'">
            <header class="h-16 bg-white/90 backdrop-blur px-6 flex justify-between items-center z-10 sticky top-0 border-b border-slate-200 shrink-0">
                <div><h2 class="text-lg font-bold text-indigo-800">æ•°æ®ç»Ÿè®¡</h2><div class="text-xs text-slate-500">å›é¡¾å·¥ä½œè¡¨ç°</div></div>
                <div class="flex items-center gap-2">
                    <select v-model="statsStatus" class="text-xs border border-slate-200 rounded px-2 py-1 outline-none bg-white text-slate-600 font-medium cursor-pointer hover:border-indigo-300 transition">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="todo">æœªå¼€å§‹</option>
                        <option value="doing">è¿›è¡Œä¸­</option>
                        <option value="done">å·²å®Œæˆ</option>
                    </select>
                    <div class="h-4 w-px bg-slate-200 mx-1"></div>
                    <button @click="setStatsRange('yesterday')" class="px-3 py-1 text-xs bg-white border border-slate-200 rounded hover:bg-slate-50">æ˜¨æ—¥</button>
                    <button @click="setStatsRange('week')" class="px-3 py-1 text-xs bg-white border border-slate-200 rounded hover:bg-slate-50">æœ¬å‘¨</button>
                    <button @click="setStatsRange('month')" class="px-3 py-1 text-xs bg-white border border-slate-200 rounded hover:bg-slate-50">æœ¬æœˆ</button>
                    <div class="h-4 w-px bg-slate-200 mx-1"></div>
                    <input type="date" v-model="statsStart" class="text-xs border border-slate-200 rounded px-2 py-1">
                    <span class="text-slate-400">-</span>
                    <input type="date" v-model="statsEnd" class="text-xs border border-slate-200 rounded px-2 py-1">
                </div>
            </header>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth pb-20">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase mb-1">æ€»ä»»åŠ¡æ•°</div><div class="text-3xl font-black text-slate-700">{{ statsData.total }}</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-green-500 uppercase mb-1">å·²å®Œæˆ</div><div class="text-3xl font-black text-green-600">{{ statsData.done }} <span class="text-sm font-medium text-slate-400">({{ statsData.rate }}%)</span></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-blue-500 uppercase mb-1">è¿›è¡Œä¸­</div><div class="text-3xl font-black text-blue-600">{{ statsData.doing }}</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div class="text-xs font-bold text-gray-500 uppercase mb-1">æœªå¼€å§‹</div><div class="text-3xl font-black text-gray-600">{{ statsData.todo }}</div></div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-50 font-bold text-slate-700">ä»»åŠ¡æ˜ç»† ({{ statsStart }} ~ {{ statsEnd }})</div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500">
                            <tr>
                                <th class="px-6 py-3 font-medium">ä»»åŠ¡åç§°</th>
                                <th class="px-6 py-3 font-medium">çŠ¶æ€</th>
                                <th class="px-6 py-3 font-medium">è®¡åˆ’ä¸æˆªæ­¢</th>
                                <th class="px-6 py-3 font-medium">å¼€å§‹ä¸ç»“æŸ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="t in statsData.list" :key="t.id" 
                                @click="selectTask(t)" 
                                class="hover:bg-slate-50 cursor-pointer transition-colors group"
                                :class="{'bg-blue-50 hover:bg-blue-100': activeTask && activeTask.id === t.id}">
                                <td class="px-6 py-3">
                                    <div class="font-bold text-slate-700">{{ t.title }}</div>
                                    <span class="px-2 py-0.5 rounded text-[10px] border inline-block mt-1" :class="getPriorityStyle(t.priority)">{{ {normal:'æ™®é€š', urgent:'ç´§æ€¥', critical:'ç‰¹æ€¥'}[t.priority] }}</span>
                                </td>
                                <td class="px-6 py-3">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-bold border" :class="getStatsStatusStyle(t)">{{ getStatsStatusLabel(t) }}</span>
                                </td>
                                <td class="px-6 py-3 text-xs">
                                    <div class="flex gap-2 mb-1"><span class="w-8 text-slate-400">è®¡åˆ’</span><span class="font-mono text-slate-600">{{ formatDateTime(t.date) }}</span></div>
                                    <div class="flex gap-2"><span class="w-8 text-slate-400">æˆªæ­¢</span><span class="font-mono" :class="isOverdue(t) ? 'text-red-500 font-bold' : 'text-slate-600'">{{ formatDateTime(t.deadline) || '-' }}</span></div>
                                </td>
                                <td class="px-6 py-3 text-xs">
                                    <div class="flex gap-2 mb-1"><span class="w-8 text-slate-400">å¼€å§‹</span><span class="font-mono text-blue-600">{{ t.startTime ? formatDateTime(t.startTime) : '-' }}</span></div>
                                    <div class="flex gap-2"><span class="w-8 text-slate-400">ç»“æŸ</span><span class="font-mono text-green-600">{{ t.completedDate ? formatDateTime(t.completedDate) : '-' }}</span></div>
                                </td>
                            </tr>
                            <tr v-if="statsData.list.length === 0">
                                <td colspan="4" class="px-6 py-8 text-center text-slate-400">è¯¥æ—¶é—´æ®µæ— æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </template>
    </main>

    <!-- 3. å³ä¾§è¯¦æƒ… (å…±ç”¨) -->
    <aside class="hidden md:flex w-[350px] bg-white border-l border-slate-200 flex-col z-10 shrink-0 h-full shadow-[-4px_0_15px_rgba(0,0,0,0.02)]">
        <div class="h-16 border-b border-slate-100 flex items-center px-6 bg-slate-50/80">
            <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph ph-sliders-horizontal"></i> ä»»åŠ¡è¯¦æƒ…</h3>
        </div>
        <div v-if="activeTask" class="flex-1 overflow-y-auto p-6 flex flex-col h-full">
            <div class="mb-6">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-[10px] font-mono uppercase px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">{{ activeTask.id.slice(-4) }}</span>
                    <span v-if="currentView==='dashboard' && !activeTask.isPreview && isOverdue(activeTask)" class="text-[10px] font-bold px-2 py-0.5 rounded bg-red-100 text-red-600 border border-red-200">å·²è¶…æ—¶</span>
                    <span v-if="activeTask.isPreview" class="text-[10px] font-bold px-2 py-0.5 rounded bg-teal-100 text-teal-600 border border-teal-200">å¾…ç”Ÿæˆ</span>
                </div>
                <h2 class="text-2xl font-black text-slate-800 leading-snug">{{ activeTask.title }}</h2>
                <div v-if="currentView === 'scheduled' && !activeTask.enabled" class="mt-2 text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded inline-block">ğŸš« å·²ç¦ç”¨</div>
            </div>

            <div class="flex-1 flex flex-col mb-6 min-h-[150px]">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 flex justify-between items-center">{{ currentView === 'dashboard' ? 'ä»»åŠ¡æè¿°' : 'é»˜è®¤å¤‡æ³¨' }}<span class="text-[10px] font-normal text-slate-400">è‡ªåŠ¨ä¿å­˜</span></label>
                <textarea v-model="activeTask.note" placeholder="è¾“å…¥å†…å®¹..." class="flex-1 w-full bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-sm text-slate-700 leading-relaxed focus:outline-none focus:ring-2 focus:ring-yellow-300 resize-none font-mono"></textarea>
            </div>
            
            <div v-if="currentView === 'scheduled'" class="mb-6 bg-teal-50 border border-teal-100 rounded-xl p-4">
                <div class="text-xs font-bold text-teal-700 uppercase mb-2">é‡å¤å‘¨æœŸ</div><div class="flex flex-wrap gap-1"><span v-for="d in formatRepeatDays(activeTask.repeatDays)" class="text-xs bg-white border border-teal-200 px-2 py-1 rounded text-teal-600 font-bold">{{ d }}</span></div>
            </div>

            <div class="mb-6 bg-slate-50 rounded-xl p-4 border border-slate-100">
                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-500 uppercase">å­ä»»åŠ¡æ¸…å•</span></div>
                <ul class="space-y-1">
                    <li v-for="sub in activeTask.subtasks" class="text-xs flex items-center gap-2"><i :class="sub.status==='done' ? 'ph-fill ph-check-circle text-green-500' : 'ph ph-circle text-slate-300'"></i><span :class="{'line-through text-slate-400': sub.status==='done', 'text-slate-600': sub.status!=='done'}">{{ sub.title }}</span></li>
                    <li v-if="activeTask.subtasks.length===0" class="text-xs text-slate-400 italic">æ— å­ä»»åŠ¡</li>
                </ul>
            </div>
            
            <div v-if="currentView !== 'templates' && currentView !== 'scheduled' && !activeTask.isPreview" class="border-t border-slate-100 pt-4 grid grid-cols-2 gap-4 text-xs">
                <div><div class="text-xs text-slate-400 mb-1">è®¡åˆ’æ—¶é—´</div><div class="text-sm font-bold text-slate-700">{{ formatDateTime(activeTask.date) }}</div></div>
                <div><div class="text-xs text-slate-400 mb-1">æˆªæ­¢æ—¶é—´</div><div class="text-sm font-bold" :class="isOverdue(activeTask) ? 'text-red-500' : 'text-slate-700'">{{ formatDateTime(activeTask.deadline) || 'æœªè®¾å®š' }}</div></div>
                <div><div class="text-xs text-slate-400 mb-1">å¼€å§‹æ—¶é—´</div><div class="text-sm font-bold text-blue-600">{{ activeTask.startTime ? formatDateTime(activeTask.startTime) : 'æœªå¼€å§‹' }}</div></div>
                <div><div class="text-xs text-slate-400 mb-1">ç»“æŸæ—¶é—´</div><div class="text-sm font-bold text-green-600">{{ activeTask.completedDate ? formatDateTime(activeTask.completedDate) : 'æœªå®Œæˆ' }}</div></div>
            </div>
        </div>
        <div v-else class="h-full flex flex-col items-center justify-center text-center opacity-40 p-10"><i class="ph ph-hand-tap text-5xl text-slate-300 mb-4 animate-bounce"></i><h4 class="font-bold text-slate-600 text-lg">ç‚¹å‡»åˆ—è¡¨é¡¹</h4><p class="text-sm text-slate-500 mt-2">æŸ¥çœ‹è¯¦æƒ…ä¸ç¼–è¾‘</p></div>
    </aside>

    <!-- æ¨¡æ€æ¡† -->
    <div v-if="modal.show" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="modal.show = false" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative flex flex-col max-h-[90vh] overflow-hidden transform transition-all">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">{{ modal.isEdit ? 'ç¼–è¾‘' : 'æ–°å»º' }}{{ getViewName() }}</h3>
                <button @click="modal.show = false" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-5">
                <div v-if="currentView === 'dashboard' && !modal.isEdit && templates.length > 0" class="bg-purple-50 border border-purple-100 rounded-lg p-3">
                    <label class="text-xs font-bold text-purple-600 uppercase mb-1 block flex items-center gap-1"><i class="ph-bold ph-magic-wand"></i> å¿«é€ŸåŠ è½½æ¨¡æ¿</label>
                    <select @change="loadTemplate($event)" class="w-full bg-white border border-purple-200 rounded px-2 py-1.5 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-200"><option value="">-- é€‰æ‹©æ¨¡æ¿ --</option><option v-for="t in templates" :key="t.id" :value="t.id">{{ t.title }}</option></select>
                </div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">åç§°</label><input v-model="modal.data.title" type="text" class="w-full text-lg font-bold border-b-2 border-slate-200 py-1 focus:border-blue-500 outline-none bg-transparent" placeholder="è¾“å…¥åç§°"></div>
                <div v-if="currentView === 'scheduled'" class="bg-teal-50 p-4 rounded-xl border border-teal-100"><label class="text-xs font-bold text-teal-700 uppercase mb-2 block">é‡å¤å‘¨æœŸ (è‡ªåŠ¨æ·»åŠ åˆ°å½“å¤©)</label><div class="flex justify-between gap-1"><label v-for="(dayStr, idx) in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="idx" class="cursor-pointer"><input type="checkbox" :value="idx === 6 ? 0 : idx + 1" v-model="modal.data.repeatDays" class="hidden peer"><span class="block w-8 h-8 rounded-full border border-teal-200 bg-white text-center leading-8 text-sm text-slate-500 peer-checked:bg-teal-500 peer-checked:text-white peer-checked:border-teal-500 transition-all select-none hover:border-teal-400">{{ dayStr }}</span></label></div></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">å¤‡æ³¨</label><textarea v-model="modal.data.note" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm resize-none"></textarea></div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">å­ä»»åŠ¡åˆ—è¡¨ (å¯æ‹–æ‹½æ’åº)</label>
                    <div class="space-y-2">
                        <div v-for="(sub, index) in modal.data.subtasks" :key="sub._key || index" 
                             class="flex gap-2 items-center group"
                             draggable="true"
                             @dragstart="dragStart(index, $event)"
                             @dragover.prevent
                             @dragenter.prevent
                             @drop="dragDrop(index)"
                             @dragend="dragEnd">
                            
                            <i class="ph-bold ph-dots-six-vertical text-slate-300 cursor-move hover:text-slate-500"></i>
                            
                            <input v-model="sub.title" class="flex-1 bg-white border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-400">
                            <button @click="modal.data.subtasks.splice(index, 1)" class="text-slate-400 hover:text-red-500"><i class="ph-bold ph-trash"></i></button>
                        </div>
                        <div class="flex gap-2">
                             <input type="text" ref="newSubInput" placeholder="è¾“å…¥æ–°å­ä»»åŠ¡æŒ‰å›è½¦..." @keydown.enter="addModalSubtask" class="flex-1 bg-transparent border-b border-slate-300 focus:border-blue-500 px-2 py-1 text-sm outline-none">
                             <button @click="addModalSubtask" class="text-blue-600 text-sm font-bold">æ·»åŠ </button>
                        </div>
                    </div>
                </div>

                <div v-if="currentView === 'dashboard'" class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-slate-500 uppercase">è®¡åˆ’æ—¶é—´</label><input type="datetime-local" v-model="modal.data.date" class="w-full border border-slate-200 rounded px-2 py-2 text-sm"></div><div><label class="text-xs font-bold text-slate-500 uppercase">æˆªæ­¢æ—¶é—´</label><input type="datetime-local" v-model="modal.data.deadline" class="w-full border border-slate-200 rounded px-2 py-2 text-sm"></div></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">ä¼˜å…ˆçº§</label><div class="flex gap-2"><button v-for="p in ['normal','urgent','critical']" :key="p" @click="modal.data.priority = p" class="flex-1 py-1.5 rounded text-xs border transition-all" :class="modal.data.priority === p ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200'">{{ {normal:'æ™®é€š', urgent:'ç´§æ€¥', critical:'ç‰¹æ€¥'}[p] }}</button></div></div>
            </div>
            <div class="p-4 border-t border-slate-100 flex justify-end gap-3 bg-white">
                <button @click="modal.show = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                <button @click="saveTask" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow">ç¡®è®¤</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- æ–°å¢é…ç½®åŒºåŸŸ ---
    // æ›¿æ¢ä¸ºä½ åˆšæ‰åœ¨ Supabase å¤åˆ¶çš„å†…å®¹
    const SUPABASE_URL = 'https://scjswpjktydojedqywxq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_TSXrb7sbhV7l5hgqjC0KuA_dVdxmSpu';

    // åˆå§‹åŒ–å®¢æˆ·ç«¯
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ç»™ä½ çš„æ•°æ®èµ·ä¸ªå”¯ä¸€çš„ä»£å·ï¼Œæ°¸è¿œåªè¯»å†™è¿™ä¸€è¡Œ
    const MY_DATA_KEY = 'my_backup_001';
    // ------------------

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                today: new Date().toISOString().split('T')[0],
                viewDate: new Date().toISOString().split('T')[0],
                now: new Date(),
                currentView: 'dashboard',
                tasks: [], templates: [], scheduledTasks: [],
                activeTask: null,
                modal: { show: false, isEdit: false, data: {} },
                isAllExpanded: false,
                statsStart: new Date().toISOString().split('T')[0],
                statsEnd: new Date().toISOString().split('T')[0],
                statsStatus: 'all',
                draggingIndex: null,
                saveTimer: null, 
                isSyncing: false, 
            }
        },
        computed: {
            dateInfo() { const date = new Date(this.viewDate); return { date: date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' }), week: date.toLocaleDateString('zh-CN', { weekday: 'long' }) }; },
            futurePreviews() {
                if (this.viewDate <= this.today) return [];
                const targetDay = new Date(this.viewDate).getDay();
                return this.scheduledTasks.filter(s => s.enabled && s.repeatDays.includes(targetDay === 0 ? 7 : targetDay)).map(s => ({ ...s, id: 'preview_' + s.id, status: 'todo', isPreview: true }));
            },
            activeTasks() {
                const list = this.tasks.filter(t => {
                    const taskDate = t.date.split('T')[0];
                    if (t.status === 'done') return false;
                    if (this.viewDate === this.today) return taskDate <= this.today;
                    else return taskDate === this.viewDate;
                });
                const pMap = { critical: 3, urgent: 2, normal: 1 };
                const sMap = { doing: 2, todo: 1 };
                return list.sort((a, b) => {
                    const pDiff = pMap[b.priority] - pMap[a.priority];
                    if (pDiff !== 0) return pDiff;
                    const aOver = this.isOverdue(a) ? 1 : 0;
                    const bOver = this.isOverdue(b) ? 1 : 0;
                    if (aOver !== bOver) return bOver - aOver;
                    const sDiff = sMap[b.status] - sMap[a.status];
                    if (sDiff !== 0) return sDiff;
                    if (a.date !== b.date) return a.date > b.date ? 1 : -1;
                    return 0;
                });
            },
            completedTasks() {
                return this.tasks.filter(t => {
                    if (t.status !== 'done') return false;
                    if (this.viewDate === this.today) return (t.date.split('T')[0] === this.today || (t.completedDate && t.completedDate.split('T')[0] === this.today));
                    else return t.date.split('T')[0] === this.viewDate;
                });
            },
            overdueCount() { return this.tasks.filter(t => t.status !== 'done' && this.isOverdue(t)).length; },
            enabledScheduledCount() { return this.scheduledTasks.filter(t => t.enabled).length; },

            statsData() {
                const start = this.statsStart;
                const end = this.statsEnd;
                if (!start || !end) return { total: 0, done: 0, rate: 0, onTime: 0, avgDuration: '-', list: [] };
                let list = this.tasks.filter(t => { const d = t.date.split('T')[0]; return d >= start && d <= end; });
                if (this.statsStatus !== 'all') { list = list.filter(t => t.status === this.statsStatus); }
                list.sort((a, b) => new Date(b.date) - new Date(a.date));
                const total = list.length;
                const doneList = list.filter(t => t.status === 'done');
                const done = doneList.length;
                const doing = list.filter(t => t.status === 'doing').length;
                const todo = list.filter(t => t.status === 'todo').length;
                const rate = total > 0 ? ((done / total) * 100).toFixed(1) : 0;
                const onTime = doneList.filter(t => { if (!t.deadline || !t.completedDate) return true; return t.completedDate <= t.deadline; }).length;
                return { total, done, doing, todo, rate, onTime, list };
            }
        },
        mounted() {
            this.loadData();
            this.checkScheduledTasks();
            this.setStatsRange('week');
            setInterval(() => { this.now = new Date(); if (this.currentView === 'dashboard' && this.viewDate === this.today) this.checkScheduledTasks(); }, 60000);
        },
        watch: {
            tasks: { handler() { this.saveData(); }, deep: true },
            templates: { handler() { this.saveData(); }, deep: true },
            scheduledTasks: { handler() { this.saveData(); }, deep: true }
        },
        methods: {
            // åœ¨ data() é‡Œé¢æ·»åŠ ä¸€ä¸ªæ–°å˜é‡ï¼Œç”¨æ¥åšé˜²æŠ–è®¡æ—¶
            data() {
                return {
                    // ... ä½ åŸæœ‰çš„å˜é‡ (today, viewDate, tasks, etc...) ...
                    saveTimer: null, // <--- æ–°å¢è¿™ä¸ª
                    isSyncing: false, // <--- æ–°å¢è¿™ä¸ªï¼ˆå¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºåŒæ­¥çŠ¶æ€ï¼‰
                    // ...
                }
            },

            methods: {
                // --- ä¿®æ”¹åçš„åŠ è½½æ•°æ® ---
                async loadData() {
                    console.log("æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...");
                    try {
                        // 1. å» Supabase æŸ¥æ•°æ®
                        const { data, error } = await supabase
                            .from('user_data')
                            .select('content')
                            .eq('my_key', MY_DATA_KEY)
                            .single();

                        if (error && error.code !== 'PGRST116') {
                            // PGRST116 ä»£è¡¨æŸ¥ä¸åˆ°æ•°æ®(ä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡ç”¨)ï¼Œé™¤æ­¤ä¹‹å¤–çš„é”™è¯¯æ‰“å°å‡ºæ¥
                            console.error('äº‘ç«¯åŠ è½½å‡ºé”™:', error);
                        }

                        if (data && data.content) {
                            // 2. å¦‚æœäº‘ç«¯æœ‰æ•°æ®ï¼Œå°±ç”¨äº‘ç«¯çš„è¦†ç›–æœ¬åœ°å˜é‡
                            const json = data.content;
                            if (json.tasks) this.tasks = json.tasks;
                            if (json.templates) this.templates = json.templates;
                            if (json.scheduledTasks) this.scheduledTasks = json.scheduledTasks;

                            // ä¸ºäº†ä¿é™©ï¼Œé¡ºä¾¿æŠŠäº‘ç«¯æ•°æ®å­˜ä¸€ä»½åˆ°æœ¬åœ° localStorage ä½œä¸ºç¼“å­˜
                            localStorage.setItem('planpro_final_tasks', JSON.stringify(this.tasks));
                            console.log("äº‘ç«¯æ•°æ®åŒæ­¥æˆåŠŸï¼");
                        } else {
                            // 3. å¦‚æœäº‘ç«¯æ˜¯ç©ºçš„ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰ï¼Œå°è¯•è¯»å–æœ¬åœ° localStorage æ—§æ•°æ®
                            console.log("äº‘ç«¯æ— æ•°æ®ï¼Œå°è¯•è¯»å–æœ¬åœ°ç¼“å­˜...");
                            const s = localStorage.getItem('planpro_final_tasks');
                            const t = localStorage.getItem('planpro_final_templates');
                            const st = localStorage.getItem('planpro_final_scheduled');
                            if (s) this.tasks = JSON.parse(s);
                            if (t) this.templates = JSON.parse(t);
                            if (st) this.scheduledTasks = JSON.parse(st);

                            // æ—¢ç„¶è¯»å–äº†æœ¬åœ°æ—§æ•°æ®ï¼Œç«‹åˆ»ä¸Šä¼ ä¸€æ¬¡åˆ°äº‘ç«¯åˆå§‹åŒ–
                            if (s || t) this.saveData();
                        }
                    } catch (err) {
                        console.error("ç½‘ç»œè¯·æ±‚å¼‚å¸¸:", err);
                        // å‘ç”Ÿæ–­ç½‘ç­‰ä¸¥é‡é”™è¯¯æ—¶ï¼Œå›é€€åˆ°æœ¬åœ°æ•°æ®ï¼Œä¿è¯èƒ½ç”¨
                        const s = localStorage.getItem('planpro_final_tasks');
                        if (s) this.tasks = JSON.parse(s);
                    }
                },

                // --- ä¿®æ”¹åçš„ä¿å­˜æ•°æ® (å¸¦é˜²æŠ–) ---
                saveData() {
                    // 1. ä¾ç„¶å…ˆå­˜æœ¬åœ°ï¼Œä¿è¯æé€Ÿä½“éªŒå’Œæ–­ç½‘å¯ç”¨
                    localStorage.setItem('planpro_final_tasks', JSON.stringify(this.tasks));
                    localStorage.setItem('planpro_final_templates', JSON.stringify(this.templates));
                    localStorage.setItem('planpro_final_scheduled', JSON.stringify(this.scheduledTasks));

                    // 2. äº‘ç«¯åŒæ­¥ï¼ˆå»¶è¿Ÿ 2 ç§’ä¿å­˜ï¼Œé˜²æ­¢é¢‘ç¹è¯·æ±‚ï¼‰
                    if (this.saveTimer) clearTimeout(this.saveTimer);

                    this.isSyncing = true; // ä½ å¯ä»¥åœ¨ç•Œé¢ä¸Šæ‰¾ä¸ªåœ°æ–¹æ˜¾ç¤º "åŒæ­¥ä¸­..."

                    this.saveTimer = setTimeout(async () => {
                        const fullData = {
                            tasks: this.tasks,
                            templates: this.templates,
                            scheduledTasks: this.scheduledTasks
                        };

                        // å‘é€åˆ° Supabase (Upsert: æœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ’å…¥)
                        const { error } = await supabase
                            .from('user_data')
                            .upsert(
                                { my_key: MY_DATA_KEY, content: fullData },
                                { onConflict: 'my_key' }
                            );

                        if (error) console.error('äº‘ç«¯ä¿å­˜å¤±è´¥:', error);
                        else console.log('äº‘ç«¯å·²è‡ªåŠ¨ä¿å­˜');

                        this.isSyncing = false;
                    }, 2000); // 2000æ¯«ç§’ = 2ç§’åæ‰§è¡Œ
                },

            // ... å…¶ä»–åŸæœ‰çš„æ–¹æ³• (dragStart, updateStatus ç­‰) ä¿æŒä¸å˜ ...

            dragStart(index, event) {
                this.draggingIndex = index;
                event.dataTransfer.effectAllowed = 'move';
                event.target.classList.add('dragging');
            },
            dragEnd(event) {
                this.draggingIndex = null;
                event.target.classList.remove('dragging');
            },
            dragDrop(toIndex) {
                const fromIndex = this.draggingIndex;
                if (fromIndex === null || fromIndex === toIndex) return;
                const list = this.modal.data.subtasks;
                const item = list.splice(fromIndex, 1)[0];
                list.splice(toIndex, 0, item);
            },

            toggleSubtask(task, sub) {
                sub.status = sub.status === 'done' ? 'todo' : 'done';
                if (sub.status === 'done' && task.status === 'todo') {
                    task.status = 'doing';
                    this.updateStatus(task);
                }
            },

            updateStatus(task) {
                if (task.status === 'done' && task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(s => s.status = 'done');
                }
                const nowIso = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                if (task.status === 'doing') {
                    if (!task.startTime) task.startTime = nowIso;
                    task.completedDate = null;
                }
                else if (task.status === 'done') {
                    task.completedDate = nowIso;
                }
                else if (task.status === 'todo') {
                    task.startTime = null;
                    task.completedDate = null;
                }
            },
            setStatsRange(type) {
                const d = new Date();
                if (type === 'yesterday') { d.setDate(d.getDate() - 1); this.statsStart = d.toISOString().split('T')[0]; this.statsEnd = d.toISOString().split('T')[0]; }
                else if (type === 'week') { const day = d.getDay() || 7; if (day !== 1) d.setHours(-24 * (day - 1)); this.statsStart = d.toISOString().split('T')[0]; d.setDate(d.getDate() + 6); this.statsEnd = d.toISOString().split('T')[0]; }
                else if (type === 'month') { const y = d.getFullYear(), m = d.getMonth(); this.statsStart = new Date(y, m, 1, 12).toISOString().split('T')[0]; this.statsEnd = new Date(y, m + 1, 0, 12).toISOString().split('T')[0]; }
            },
            calculateDuration(t) { if (!t.startTime || !t.completedDate) return '-'; const s = new Date(t.startTime); const e = new Date(t.completedDate); const diff = (e - s) / 60000; if (diff < 0) return '-'; const h = Math.floor(diff / 60); const m = Math.floor(diff % 60); return (h > 0 ? h + 'h ' : '') + m + 'm'; },

            // --- æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ† ---
            checkScheduledTasks() {
                const todayStr = this.today;
                const todayDate = new Date(todayStr); // è·å–ä»Šå¤©çš„æ—¶é—´å¯¹è±¡
                let addedCount = 0;

                this.scheduledTasks.forEach(sch => {
                    if (!sch.enabled) return;

                    // 1. ç¡®å®šå¼€å§‹æ£€æŸ¥çš„æ—¥æœŸ
                    // é€»è¾‘ï¼šå¦‚æœè¿™ä¸ªå®šæ—¶ä»»åŠ¡æœ‰ "lastGeneratedDate" (ä¸Šæ¬¡ç”Ÿæˆæ—¥æœŸ)ï¼Œ
                    // é‚£ä¹ˆæˆ‘ä»¬å°±ä» ä¸Šæ¬¡ç”Ÿæˆæ—¥æœŸçš„åä¸€å¤© å¼€å§‹æ£€æŸ¥ï¼Œä¸€ç›´æ£€æŸ¥åˆ°ä»Šå¤©ã€‚
                    // å¦‚æœæ²¡æœ‰ (æ–°å»ºä»»åŠ¡)ï¼Œåˆ™åªæ£€æŸ¥ä»Šå¤©ã€‚
                    let checkDate;
                    if (sch.lastGeneratedDate) {
                        const last = new Date(sch.lastGeneratedDate);
                        checkDate = new Date(last);
                        checkDate.setDate(checkDate.getDate() + 1); // ä»ä¸Šæ¬¡çš„æ˜å¤©å¼€å§‹
                    } else {
                        checkDate = new Date(todayDate); // å¦‚æœæ˜¯æ–°ä»»åŠ¡ï¼Œåªçœ‹ä»Šå¤©
                    }

                    // 2. å¾ªç¯éå†æ¯ä¸€å¤©ï¼Œç›´åˆ°è¦†ç›–åˆ°ä»Šå¤©
                    while (checkDate <= todayDate) {
                        const dayOfWeek = checkDate.getDay(); // 0-6 (0æ˜¯å‘¨æ—¥)
                        const dateString = checkDate.toISOString().split('T')[0];

                        // 3. æ£€æŸ¥è¿™ä¸€å¤©æ˜¯å¦åœ¨è®¾å®šçš„å‘¨å‡ é‡Œé¢
                        // åœ¨JS getDay()ä¸­ï¼Œå‘¨æ—¥æ˜¯0ã€‚ä½ çš„ç•Œé¢é€»è¾‘é‡Œå‘¨æ—¥ä¹Ÿæ˜¯æ˜ å°„ä¸º0ï¼ŒåŒ¹é…ã€‚
                        if (sch.repeatDays.includes(dayOfWeek)) {
                            // ç”Ÿæˆä»»åŠ¡
                            const newTask = {
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                title: sch.title,
                                status: 'todo',
                                priority: sch.priority,
                                // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ checkDate (è¡¥æ¼çš„é‚£ä¸€å¤©) ä½œä¸ºä»»åŠ¡æ—¥æœŸï¼Œè€Œä¸æ˜¯ this.today
                                date: dateString + 'T09:00',
                                deadline: '',
                                note: sch.note,
                                subtasks: JSON.parse(JSON.stringify(sch.subtasks)),
                                expanded: false,
                                isFromSchedule: true
                            };
                            newTask.subtasks.forEach(s => s.status = 'todo');
                            this.tasks.push(newTask);
                            addedCount++;
                        }

                        // æ£€æŸ¥å®Œè¿™ä¸€å¤©ï¼Œå¾€åæ¨ä¸€å¤©
                        checkDate.setDate(checkDate.getDate() + 1);
                    }

                    // 4. æ›´æ–°æ ‡è®°ï¼Œè¡¨ç¤ºæˆªæ­¢åˆ°ä»Šå¤©éƒ½å·²ç»å¤„ç†è¿‡äº†
                    sch.lastGeneratedDate = todayStr;
                });

                if (addedCount > 0) this.saveData();
            },
            // --- ä¿®æ”¹ç»“æŸ ---

            changeDate(offset) { const d = new Date(this.viewDate); d.setDate(d.getDate() + offset); this.viewDate = d.toISOString().split('T')[0]; this.activeTask = null; },
            resetToToday() { this.viewDate = this.today; this.checkScheduledTasks(); },
            switchView(view) { this.currentView = view; this.activeTask = null; if (view === 'dashboard') { this.viewDate = this.today; this.checkScheduledTasks(); } },
            getViewName() { return { dashboard: 'ä»»åŠ¡', templates: 'æ¨¡æ¿', scheduled: 'å®šæ—¶', statistics: 'ç»Ÿè®¡' }[this.currentView]; },
            selectTask(task) { this.activeTask = task; },
            toggleAll() { this.isAllExpanded = !this.isAllExpanded; this.activeTasks.forEach(t => t.expanded = this.isAllExpanded); },
            deleteTask(id) {
                if (confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
                    if (this.currentView === 'dashboard') this.tasks = this.tasks.filter(t => t.id !== id);
                    else if (this.currentView === 'templates') this.templates = this.templates.filter(t => t.id !== id);
                    else if (this.currentView === 'scheduled') this.scheduledTasks = this.scheduledTasks.filter(t => t.id !== id);
                    if (this.activeTask && this.activeTask.id === id) this.activeTask = null;
                }
            },
            loadTemplate(event) {
                const tmpl = this.templates.find(t => t.id === event.target.value);
                if (tmpl) {
                    this.modal.data.title = tmpl.title; this.modal.data.priority = tmpl.priority; this.modal.data.note = tmpl.note;
                    this.modal.data.subtasks = JSON.parse(JSON.stringify(tmpl.subtasks));
                    this.modal.data.subtasks.forEach(s => s.status = 'todo');
                }
                event.target.value = "";
            },
            exportData() {
                const blob = new Blob([JSON.stringify({ tasks: this.tasks, templates: this.templates, scheduledTasks: this.scheduledTasks }, null, 2)], { type: "application/json" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `planpro_backup_${this.today}.json`; a.click();
            },
            importData(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (confirm('æ¢å¤æ•°æ®å°†åˆå¹¶ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                            const merge = (s, t) => {
                                const ids = new Set(t.map(x => x.id));
                                s.forEach(x => { if (x.expanded === undefined) x.expanded = false; if (!ids.has(x.id)) t.push(x); else t[t.findIndex(o => o.id === x.id)] = x; });
                            };
                            if (json.tasks) merge(json.tasks, this.tasks);
                            if (json.templates) merge(json.templates, this.templates);
                            if (json.scheduledTasks) merge(json.scheduledTasks, this.scheduledTasks);
                            alert('æ¢å¤æˆåŠŸï¼'); location.reload();
                        }
                    } catch (err) { alert('æ–‡ä»¶æ— æ•ˆ'); }
                };
                reader.readAsText(file); event.target.value = '';
            },
            verifySuper(cb) { const p = prompt("è¯·è¾“å…¥è¶…çº§å¯†ç ï¼š"); if (p === 'QSQ8888') cb(); else if (p) alert("å¯†ç é”™è¯¯"); },
            handleClearData() { this.verifySuper(() => { if (confirm("âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼")) { localStorage.clear(); location.reload(); } }); },
            handleOpenPath() {
                const size = new Blob([localStorage.getItem('planpro_final_tasks')]).size + new Blob([localStorage.getItem('planpro_final_templates')]).size;
                alert(`ğŸ“‚ æ•°æ®å­˜å‚¨ä¿¡æ¯\n\nä½ç½®ï¼šæµè§ˆå™¨å†…éƒ¨ LocalStorage (SQLite/LevelDB)\nå ç”¨ï¼šçº¦ ${(size / 1024).toFixed(2)} KB\n\nä½œè€…ï¼šåŒé±¼\nå½“å‰ç‰ˆæœ¬ï¼šv3.0.0`);
            },
            openModal(task = null) {
                this.modal.show = true;
                if (task) {
                    this.modal.isEdit = true;
                    this.modal.data = JSON.parse(JSON.stringify(task));
                    if (this.modal.data.subtasks) this.modal.data.subtasks.forEach(s => { if (!s._key) s._key = Math.random(); });
                }
                else {
                    this.modal.isEdit = false;
                    const nowTime = new Date().toTimeString().slice(0, 5);
                    const defaultDateTime = (this.currentView === 'dashboard') ? this.viewDate + 'T' + nowTime : this.today + 'T09:00';
                    this.modal.data = { id: Date.now().toString(), title: '', status: 'todo', priority: 'normal', date: defaultDateTime, deadline: '', note: '', subtasks: [], expanded: false, repeatDays: this.currentView === 'scheduled' ? [1, 2, 3, 4, 5] : [], enabled: true };
                }
            },
            addModalSubtask() {
                const val = this.$refs.newSubInput.value.trim();
                if (val) {
                    if (!this.modal.data.subtasks) this.modal.data.subtasks = [];
                    this.modal.data.subtasks.push({ title: val, status: 'todo', _key: Math.random() });
                    this.$refs.newSubInput.value = '';
                }
            },
            saveTask() {
                if (!this.modal.data.title.trim()) return;
                const d = this.modal.data;
                if (this.currentView === 'dashboard' && d.status === 'done') {
                    const now = new Date();
                    d.completedDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                }
                let arr = this.currentView === 'dashboard' ? this.tasks : (this.currentView === 'templates' ? this.templates : this.scheduledTasks);
                if (this.modal.isEdit) {
                    const idx = arr.findIndex(t => t.id === d.id); d.expanded = arr[idx].expanded; arr[idx] = d;
                    if (this.activeTask && this.activeTask.id === d.id) this.activeTask = d;
                } else { arr.push(d); }
                this.modal.show = false;
            },
            addInlineSubtask(task, e) { const val = e.target.value.trim(); if (val) { task.subtasks.push({ title: val, status: 'todo', _key: Math.random() }); e.target.value = ''; } },
            isOverdue(t) {
                if (!t.deadline) return false;
                const currentLocal = new Date(this.now.getTime() - (this.now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                return t.deadline < currentLocal;
            },
            isDueToday(t) { return t.deadline && t.deadline.startsWith(this.today); },
            calculateProgress(t) { if (!t.subtasks || !t.subtasks.length) return 0; return (t.subtasks.filter(s => s.status === 'done').length / t.subtasks.length) * 100; },
            getLatestNoteLine(n) { return n ? n.split('\n').filter(l => l.trim()).pop() : ''; },
            getStatusStyle(s) { return { 'todo': 'bg-slate-100 text-slate-500 border-slate-200', 'doing': 'bg-blue-50 text-blue-600 border-blue-200', 'done': 'bg-green-50 text-green-600 border-green-200' }[s]; },
            getPriorityStyle(p) { return { 'normal': 'bg-white text-slate-600 border-slate-200 hover:border-blue-300', 'urgent': 'bg-orange-50 text-orange-600 border-orange-200', 'critical': 'bg-red-50 text-red-600 border-red-200' }[p]; },
            formatRepeatDays(days) {
                if (!days || days.length === 0) return ['æ— '];
                const map = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 0: 'æ—¥' };
                return days.sort((a, b) => (a === 0 ? 7 : a) - (b === 0 ? 7 : b)).map(d => 'å‘¨' + map[d]);
            },
            formatTimeOnly(dateTimeStr) { if (!dateTimeStr) return ''; if (dateTimeStr.includes('T')) return dateTimeStr.split('T')[1]; return ''; },
            formatDateTime(dateTimeStr) { if (!dateTimeStr) return ''; return dateTimeStr.replace('T', ' '); },

            getStatsStatusStyle(t) {
                if (t.status === 'done') {
                    if (t.deadline && t.completedDate > t.deadline) return 'bg-red-100 text-red-700 border-red-200';
                    return 'bg-green-100 text-green-700 border-green-200';
                }
                if (t.status === 'doing') return 'bg-blue-100 text-blue-700 border-blue-200';
                return 'bg-slate-100 text-slate-500 border-slate-200';
            },
            getStatsStatusLabel(t) {
                if (t.status === 'done') {
                    if (t.deadline && t.completedDate > t.deadline) return 'è¶…æ—¶å®Œæˆ';
                    return 'å·²å®Œæˆ';
                }
                return { 'todo': 'æœªå¼€å§‹', 'doing': 'è¿›è¡Œä¸­' }[t.status];
            }
        }
    }).mount('#app');
</script>
</body>
</html>
